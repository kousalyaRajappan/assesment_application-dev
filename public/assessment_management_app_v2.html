<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .login-section {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #667eea;
            outline: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        #submitAssessmentBtn {
            transition: all 0.3s ease;
        }

        #submitAssessmentBtn:hover {
            transform: scale(1.1) translateY(-3px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .nav-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .question-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        .question-card:hover {
            border-color: #667eea;
        }
 .auth-toggle {
            text-align: center;
            margin: 20px 0;
        }

        .auth-toggle button {
            background: none;
            border: none;
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            font-size: 16px;
        }
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .file-upload:hover {
            background-color: #e3f2fd;
            border-color: #4054b2;
            transform: translateY(-1px);
        }

        .file-upload.dragover {
            background-color: #e8f5e8;
            border-color: #28a745;
            border-style: solid;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
        }

        .schedule-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-open {
            background: #d4edda;
            color: #155724;
        }

        .status-closed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .answer-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .score-input {
            width: 80px;
            display: inline-block;
            margin-right: 10px;
        }

        .timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stats-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .student-selection {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .student-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .student-item {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            user-select: none;
        }

        .student-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-1px);
        }

        .student-item.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .answer-type-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .answer-type-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }

        .answer-type-item.selected {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .text-limit-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .text-limit-item {
            background: #f8f9fa;
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }

        .text-limit-item.selected {
            background: #667eea;
            color: white;
        }

        .answer-input-group {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .answer-input-group h5 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .char-counter {
            font-size: 12px;
            color: #666;
            text-align: right;
            margin-top: 5px;
        }

        .char-counter.error {
            color: #dc3545;
        }

        .char-counter.success {
            color: #28a745;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .question-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .student-list {
                justify-content: center;
            }

            .preset-buttons {
                grid-template-columns: 1fr;
            }
        }

        /* Simplified Schedule Section */
        .schedule-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }

        .schedule-section h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .quick-presets {
            margin-bottom: 20px;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .preset-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .preset-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .preset-btn.active {
            background: #28a745;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .duration-info {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 15px;
            text-align: center;
            font-weight: 600;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="card">
            <div class="header">
                <h1>Assessment Management System</h1>
                <p>Comprehensive platform for creating and managing assessments</p>
            </div>
            
            <div class="login-section">
                <div class="form-group">
                    <label for="userRole">Select Role:</label>
                    <select id="userRole">
                        <option value="">Choose your role</option>
                        <option value="admin">Administrator</option>
                        <option value="student">Student</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" placeholder="Enter your username">
                </div>
                
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" placeholder="Enter your password">
                </div>
                
                <button class="btn" onclick="login()" style="width: 100%;">Login</button>
                 <div class="auth-toggle">
                    <p>New Student? <button onclick="showStudentRegistration()">Register with Mobile OTP</button></p>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="dashboard">
            <div class="card">
                <div class="header">
                    <h1>Administrator Dashboard</h1>
                    <button class="btn btn-secondary" onclick="logout()">Logout</button>
                </div>

                <!-- Admin Stats -->
                <div class="grid">
                    <div class="stats-card">
                        <div class="stats-number" id="totalAssessments">0</div>
                        <div>Total Assessments</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="totalQuestions">0</div>
                        <div>Total Questions</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="totalSubmissions">0</div>
                        <div>Total Submissions</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="totalStudents">0</div>
                        <div>Active Students</div>
                    </div>
                </div>

                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showAdminTab('create-assessment')">Create Assessment</button>
                    <button class="nav-tab" onclick="showAdminTab('manage-students')">Manage Students</button>
                    <button class="nav-tab" onclick="showAdminTab('manage-assessments')">Manage Assessments</button>
                    <button class="nav-tab" onclick="showAdminTab('grade-submissions')">Grade Submissions</button>
                    <button class="nav-tab" onclick="showAdminTab('view-results')">View Results</button>
                </div>

                <!-- Create Assessment Tab -->
                <div id="create-assessment" class="tab-content active">
                    <h3>Create New Assessment</h3>
                    
                    <div class="form-group">
                        <label for="assessmentTitle">Assessment Title:</label>
                        <input type="text" id="assessmentTitle" placeholder="Enter assessment title">
                    </div>
                    
                    <div class="form-group">
                        <label for="assessmentDescription">Description:</label>
                        <textarea id="assessmentDescription" rows="3" placeholder="Enter assessment description"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="maxScore">Maximum Score:</label>
                        <input type="number" id="maxScore" placeholder="Enter maximum score" value="100" style="width: 150px;">
                    </div>

                    <!-- Simplified Schedule Section -->
                    <div class="schedule-section">
                        <h4>📅 Schedule</h4>
                        
                        <!-- Quick Presets -->
                        <div class="quick-presets">
                            <label>Quick Setup:</label>
                            <div class="preset-buttons">
                                <button type="button" class="preset-btn" onclick="setQuickPreset('now-1hour')">Now → 1 Hour</button>
                                <button type="button" class="preset-btn" onclick="setQuickPreset('now-1day')">Now → 1 Day</button>
                                <button type="button" class="preset-btn" onclick="setQuickPreset('tomorrow-1week')">Tomorrow → 1 Week</button>
                            </div>
                        </div>

                        <!-- Date Inputs -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                            <div class="form-group">
                                <label for="startDate">Start Date:</label>
                                <input type="datetime-local" id="startDate">
                            </div>
                            
                            <div class="form-group">
                                <label for="endDate">End Date:</label>
                                <input type="datetime-local" id="endDate">
                            </div>
                        </div>

                        <!-- Simple Duration Display -->
                        <div class="duration-info" id="durationInfo" style="display: none;">
                            <span id="durationText"></span>
                        </div>
                    </div>

                    <!-- Student Assignment Section -->
                    <div class="student-selection">
                        <label><strong>Assign to Students:</strong></label>
                        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Select students who can take this assessment (leave none selected for ALL students)</p>
                        
                        <div class="student-list" id="studentAssignmentList"></div>
                        
                        <div id="selectionSummary" style="margin: 10px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px; font-weight: bold;">
                            No students selected - assessment will be available to ALL students
                        </div>
                        
                        <div style="margin-top: 10px;">
                            <button type="button" class="btn btn-secondary" onclick="selectAllStudents()">Select All</button>
                            <button type="button" class="btn btn-secondary" onclick="clearStudentSelection()">Clear All</button>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="createAssessment()">Create Assessment</button>
                </div>

                <!-- Manage Students Tab -->
                <div id="manage-students" class="tab-content">
                    <h3>Manage Students</h3>
                    
                    <div class="form-group">
                        <label for="newStudentName">Add New Student:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="newStudentName" placeholder="Enter student name">
                            <button class="btn" onclick="addStudent()">Add Student</button>
                        </div>
                    </div>
                    
                    <div id="studentsList"></div>
                </div>

                <!-- Manage Assessments Tab -->
                <div id="manage-assessments" class="tab-content">
                    <h3>Manage Assessments</h3>
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-secondary" onclick="refreshAssessmentsList()">🔄 Refresh List</button>
                        <button class="btn btn-secondary" onclick="debugAssessments()">🐛 Debug Info</button>
                        <button class="btn btn-secondary" onclick="testAssignmentButtons()">🧪 Test Assignment</button>
                    </div>
                    <div id="assessmentsList"></div>
                </div>

                <!-- Grade Submissions Tab -->
                <div id="grade-submissions" class="tab-content">
                    <h3>Grade Submissions</h3>
                    <div id="submissionsList"></div>
                </div>

                <!-- View Results Tab -->
                <div id="view-results" class="tab-content">
                    <h3>Assessment Results</h3>
                    <div id="resultsList"></div>
                </div>
            </div>
        </div>

        <!-- Student Dashboard -->
        <div id="studentDashboard" class="dashboard">
            <div class="card">
                <div class="header">
                    <h1>Student Dashboard</h1>
                    <p>Welcome, <span id="studentName"></span>!</p>
                    <button class="btn btn-secondary" onclick="logout()">Logout</button>
                </div>

                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showStudentTab('available-assessments')">Available Assessments</button>
                    <button class="nav-tab" onclick="showStudentTab('my-submissions')">My Submissions</button>
                    <button class="nav-tab" onclick="showStudentTab('results')">Results</button>
                </div>

                <!-- Available Assessments Tab -->
                <div id="available-assessments" class="tab-content active">
                    <h3>Available Assessments</h3>
                    <div id="studentAssessmentsList"></div>
                </div>

                <!-- My Submissions Tab -->
                <div id="my-submissions" class="tab-content">
                    <h3>My Submissions</h3>
                    <div id="mySubmissionsList"></div>
                </div>

                <!-- Results Tab -->
                <div id="results" class="tab-content">
                    <h3>My Results</h3>
                    <div id="myResultsList"></div>
                </div>
            </div>
        </div>

        <!-- Timer Display -->
        <div id="timer" class="timer" style="display: none;"></div>
    </div>

    <!-- Question Creation Modal -->
    <div id="questionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 700px; max-height: 90%; overflow-y: auto;">
            <h3>Add Question to Assessment</h3>
            
            <div class="form-group">
                <label for="questionText">Question:</label>
                <textarea id="questionText" rows="3" placeholder="Enter your question"></textarea>
            </div>
            
            <div class="form-group">
                <label><strong>Answer Types (Select one or more):</strong></label>
                <div class="answer-type-group">
                    <div class="answer-type-item" data-type="text" onclick="toggleAnswerType('text')">📝 Text Answer</div>
                    <div class="answer-type-item" data-type="file" onclick="toggleAnswerType('file')">📎 File Upload</div>
                    <div class="answer-type-item" data-type="url" onclick="toggleAnswerType('url')">🔗 GitHub/GitLab Link</div>
                    <div class="answer-type-item" data-type="voice" onclick="toggleAnswerType('voice')">🎤 Voice Recording</div>
                    <div class="answer-type-item" data-type="code" onclick="toggleAnswerType('code')">💻 Code Snippet</div>
                </div>
            </div>

            <!-- Text Limitations -->
            <div id="textLimitSection" style="display: none;">
                <div class="form-group">
                    <label><strong>Text Minimum Requirements:</strong></label>
                    <div class="text-limit-options">
                        <div class="text-limit-item" data-limit="50" onclick="selectTextLimit(50)">Min 50 chars</div>
                        <div class="text-limit-item" data-limit="100" onclick="selectTextLimit(100)">Min 100 chars</div>
                        <div class="text-limit-item" data-limit="200" onclick="selectTextLimit(200)">Min 200 chars</div>
                        <div class="text-limit-item" data-limit="500" onclick="selectTextLimit(500)">Min 500 chars</div>
                        <div class="text-limit-item" data-limit="1000" onclick="selectTextLimit(1000)">Min 1000 chars</div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="questionPoints">Points:</label>
                <input type="number" id="questionPoints" placeholder="Points for this question" value="10">
            </div>
            
            <div class="form-group">
                <label for="questionInstructions">Additional Instructions:</label>
                <textarea id="questionInstructions" rows="2" placeholder="Any specific instructions for this question"></textarea>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeQuestionModal()">Cancel</button>
                <button class="btn" onclick="addQuestion()">Add Question</button>
            </div>
        </div>
    </div>

    <!-- Assessment Taking Modal -->
    <div id="assessmentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 95%; max-width: 900px; max-height: 90%; overflow-y: auto;">
            <div id="assessmentContent"></div>
        </div>
    </div>

    <script>
        // Global data storage
        let currentUser = null;
        let assessments = [];
        let submissions = [];
        let students = ['john_doe', 'jane_smith', 'alice_johnson', 'bob_wilson', 'emma_davis'];
        let currentAssessmentId = null;
        let currentTimer = null;
        let selectedAnswerTypes = [];
        let selectedTextLimit = null;

        // Sample data initialization
        function initializeSampleData() {
            // Clear any existing data first
            assessments = [];
            submissions = [];
            
            // Create a sample assessment that's available to ALL students
            assessments.push({
                id: 'assessment_demo_' + Date.now(),
                title: 'JavaScript Fundamentals - Demo Assessment',
                description: 'Test your knowledge of JavaScript basics. This assessment is available to ALL students regardless of username.',
                startDate: new Date(Date.now() - 86400000).toISOString(), // Started yesterday
                endDate: new Date(Date.now() + 7 * 86400000).toISOString(), // Ends in 7 days
                maxScore: 100,
                createdBy: 'admin',
                assignedStudents: [], // Empty array = available to ALL students
                questions: [
                    {
                        id: 'q1_' + Date.now(),
                        text: 'Explain the concept of closures in JavaScript with an example.',
                        types: ['text'],
                        textLimit: 200,
                        points: 25,
                        instructions: 'Provide a clear explanation with code examples.'
                    },
                    {
                        id: 'q2_' + Date.now(),
                        text: 'Upload a screenshot of your JavaScript development environment and provide a GitHub link to your project.',
                        types: ['file', 'url'],
                        points: 35,
                        instructions: 'Include your IDE/editor with a simple JS file open and make sure the repository is public.'
                    },
                    {
                        id: 'q3_' + Date.now(),
                        text: 'Record a voice explanation of the difference between var, let, and const, and also write a summary.',
                        types: ['voice', 'text'],
                        textLimit: 100,
                        points: 40,
                        instructions: 'Keep the voice explanation under 3 minutes and write a concise summary.'
                    }
                ]
            });
            
            console.log('Sample data initialized - Assessment available to ALL students');
            console.log('Demo assessment created:', assessments[0]);
        }

        // Authentication
        function login() {
            const role = document.getElementById('userRole').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!role || !username || !password) {
                alert('Please fill in all fields');
                return;
            }

            currentUser = { username, role };
            document.getElementById('loginSection').style.display = 'none';
            
            if (role === 'admin') {
                document.getElementById('adminDashboard').classList.add('active');
                loadAdminDashboard();
            } else {
                document.getElementById('studentDashboard').classList.add('active');
                document.getElementById('studentName').textContent = username;
                loadStudentDashboard();
            }
        }

        function logout() {
            currentUser = null;
            selectedAnswerTypes = [];
            selectedTextLimit = null;
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminDashboard').classList.remove('active');
            document.getElementById('studentDashboard').classList.remove('active');
            
            // Clear form
            document.getElementById('userRole').value = '';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Admin Dashboard Functions
        function showAdminTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            switch(tabName) {
                case 'create-assessment':
                    loadStudentAssignmentList();
                    updateSelectionSummary();
                    break;
                case 'manage-students':
                    loadStudentsList();
                    break;
                case 'manage-assessments':
                    loadAssessmentsList();
                    break;
                case 'grade-submissions':
                    loadSubmissionsList();
                    break;
                case 'view-results':
                    loadResultsList();
                    break;
            }
        }

        function loadAdminDashboard() {
            console.log('Loading admin dashboard...');
            updateAdminStats();
            loadStudentAssignmentList();
            loadAssessmentsList();
        }

        function updateAdminStats() {
            document.getElementById('totalAssessments').textContent = assessments.length;
            document.getElementById('totalQuestions').textContent = 
                assessments.reduce((sum, assessment) => sum + (assessment.questions ? assessment.questions.length : 0), 0);
            document.getElementById('totalSubmissions').textContent = submissions.length;
            document.getElementById('totalStudents').textContent = students.length;
        }

        function loadStudentAssignmentList() {
            console.log('Loading student assignment list...');
            const container = document.getElementById('studentAssignmentList');
            if (!container) {
                console.error('Student assignment container not found!');
                return;
            }
            
            container.innerHTML = '';
            console.log('Available students:', students);

            if (students.length === 0) {
                container.innerHTML = '<p style="color: #666;">No students available. Add students first in the "Manage Students" tab.</p>';
                return;
            }

            students.forEach(student => {
                const studentItem = document.createElement('div');
                studentItem.className = 'student-item';
                studentItem.textContent = student;
                studentItem.setAttribute('data-student', student);
                
                // Add click handler with better event binding
                studentItem.addEventListener('click', function() {
                    console.log('Student clicked:', student);
                    toggleStudentSelection(student);
                });
                
                container.appendChild(studentItem);
            });
            
            console.log('Student assignment list loaded with', students.length, 'students');
        }

        function toggleStudentSelection(studentName) {
            console.log('Toggling selection for student:', studentName);
            
            // Use more specific selector to avoid conflicts
            const item = document.querySelector(`#studentAssignmentList [data-student="${studentName}"]`);
            
            if (!item) {
                console.error('Student item not found:', studentName);
                return;
            }
            
            item.classList.toggle('selected');
            
            const isSelected = item.classList.contains('selected');
            console.log('Student', studentName, 'is now', isSelected ? 'selected' : 'unselected');
            
            // Update visual feedback
            updateSelectionSummary();
        }

        function updateSelectionSummary() {
            const selectedStudents = getSelectedStudents();
            const summaryElement = document.getElementById('selectionSummary');
            
            if (summaryElement) {
                if (selectedStudents.length === 0) {
                    summaryElement.textContent = 'No students selected - assessment will be available to ALL students';
                    summaryElement.style.color = '#28a745';
                } else {
                    summaryElement.textContent = `Selected: ${selectedStudents.join(', ')} (${selectedStudents.length} students)`;
                    summaryElement.style.color = '#007bff';
                }
            }
        }

        function selectAllStudents() {
            console.log('Selecting all students');
            document.querySelectorAll('#studentAssignmentList .student-item').forEach(item => {
                item.classList.add('selected');
            });
            updateSelectionSummary();
        }

        function clearStudentSelection() {
            console.log('Clearing all student selections');
            document.querySelectorAll('#studentAssignmentList .student-item').forEach(item => {
                item.classList.remove('selected');
            });
            updateSelectionSummary();
        }

        function getSelectedStudents() {
            const selectedItems = document.querySelectorAll('#studentAssignmentList .student-item.selected');
            const selectedStudents = Array.from(selectedItems).map(item => item.getAttribute('data-student'));
            console.log('Currently selected students:', selectedStudents);
            return selectedStudents;
        }

        function addStudent() {
            const newStudentName = document.getElementById('newStudentName').value.trim();
            if (!newStudentName) {
                alert('Please enter a student name');
                return;
            }

            if (students.includes(newStudentName)) {
                alert('Student already exists');
                return;
            }

            students.push(newStudentName);
            document.getElementById('newStudentName').value = '';
            loadStudentsList();
            loadStudentAssignmentList();
            updateAdminStats();
            alert('Student added successfully!');
        }

        function loadStudentsList() {
            const container = document.getElementById('studentsList');
            container.innerHTML = '';

            students.forEach(student => {
                const studentCard = document.createElement('div');
                studentCard.className = 'question-card';
                
                studentCard.innerHTML = `
                    <div class="question-header">
                        <h4>${student}</h4>
                        <button class="btn btn-danger" onclick="removeStudent('${student}')">Remove</button>
                    </div>
                `;
                
                container.appendChild(studentCard);
            });
        }

        function removeStudent(studentName) {
            if (confirm(`Are you sure you want to remove student "${studentName}"?`)) {
                students = students.filter(s => s !== studentName);
                loadStudentsList();
                loadStudentAssignmentList();
                updateAdminStats();
            }
        }

        function testStudentSelection() {
            console.log('=== TESTING STUDENT SELECTION ===');
            const selectedStudents = getSelectedStudents();
            
            let testInfo = `STUDENT SELECTION TEST:\n\n`;
            testInfo += `Total Students Available: ${students.length}\n`;
            testInfo += `Students: ${students.join(', ')}\n\n`;
            testInfo += `Selected Students: ${selectedStudents.length}\n`;
            
            if (selectedStudents.length > 0) {
                testInfo += `Selected: ${selectedStudents.join(', ')}\n\n`;
                testInfo += `Assessment Assignment: SPECIFIC STUDENTS\n`;
                testInfo += `Only these students will see the assessment.`;
            } else {
                testInfo += `Selected: None\n\n`;
                testInfo += `Assessment Assignment: ALL STUDENTS\n`;
                testInfo += `Any student who logs in will see the assessment.`;
            }
            
            alert(testInfo);
        }

        function createAssessment() {
            console.log('=== CREATING ASSESSMENT WITH ENHANCED VALIDATION ===');
            
            const title = document.getElementById('assessmentTitle').value.trim();
            const description = document.getElementById('assessmentDescription').value.trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const maxScore = document.getElementById('maxScore').value;

            // Enhanced validation
            if (!title) {
                alert('📝 Please enter an assessment title');
                document.getElementById('assessmentTitle').focus();
                return;
            }

            if (!startDate || !endDate) {
                alert('📅 Please select both start and end dates');
                return;
            }

            const startDateTime = new Date(startDate);
            const endDateTime = new Date(endDate);
            const now = new Date();

            // Date validation
            if (endDateTime <= startDateTime) {
                alert('⚠️ End date must be after start date!\n\nPlease adjust your dates.');
                return;
            }

            // Optional: Warn about past dates
            if (endDateTime <= now) {
                if (!confirm('⚠️ Your assessment end date is in the past.\n\nStudents won\'t be able to take this assessment.\n\nDo you want to continue anyway?')) {
                    return;
                }
            }

            // Optional: Warn about very short durations
            const duration = endDateTime - startDateTime;
            const durationMinutes = duration / (1000 * 60);
            if (durationMinutes < 30) {
                if (!confirm(`⏰ This assessment duration is very short (${Math.round(durationMinutes)} minutes).\n\nAre you sure students will have enough time?\n\nClick OK to continue or Cancel to adjust.`)) {
                    return;
                }
            }

            const assignedStudents = getSelectedStudents();
            console.log('Selected students for assignment:', assignedStudents);

            let assignmentType;
            let finalAssignedStudents;

            if (assignedStudents.length === 0) {
                // No students selected = available to ALL students
                assignmentType = 'ALL STUDENTS';
                finalAssignedStudents = []; // Empty array means all students
            } else {
                // Specific students selected
                assignmentType = 'SPECIFIC STUDENTS';
                finalAssignedStudents = assignedStudents;
            }

            const assessment = {
                id: 'assessment_' + Date.now(),
                title,
                description: description || 'No description provided',
                startDate,
                endDate,
                maxScore: parseInt(maxScore) || 100,
                createdBy: currentUser.username,
                assignedStudents: finalAssignedStudents,
                questions: []
            };

            console.log('Creating assessment:', assessment);
            assessments.push(assessment);
            currentAssessmentId = assessment.id;
            
            // Clear form with better UX
            document.getElementById('assessmentTitle').value = '';
            document.getElementById('assessmentDescription').value = '';
            document.getElementById('maxScore').value = '100';
            clearStudentSelection();
            
            // Reset to smart defaults
            setSmartDefaults();
            
            // Remove active preset selection
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            updateAdminStats();
            
            // Enhanced success message with timing info
            const startTime = new Date(startDate).toLocaleString();
            const endTime = new Date(endDate).toLocaleString();
            const durationDays = Math.floor(duration / (1000 * 60 * 60 * 24));
            const durationHours = Math.floor((duration % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            let durationText = '';
            if (durationDays > 0) durationText += `${durationDays} day${durationDays > 1 ? 's' : ''} `;
            if (durationHours > 0) durationText += `${durationHours} hour${durationHours > 1 ? 's' : ''}`;
            
            const successMessage = `✨ Assessment "${title}" created successfully! ✨\n\n` +
                                 `📅 Schedule:\n` +
                                 `• Start: ${startTime}\n` +
                                 `• End: ${endTime}\n` +
                                 `• Duration: ${durationText}\n\n` +
                                 `👥 Assignment: ${assignmentType}\n` +
                                 (assignmentType === 'SPECIFIC STUDENTS' ? 
                                  `Students: ${finalAssignedStudents.join(', ')}\n\n` : 
                                  'Available to all students\n\n') +
                                 `🎯 Next Step: Add questions to your assessment`;
            
            alert(successMessage);
            
            // Auto-switch to manage assessments tab
            setTimeout(() => {
                showAdminTab('manage-assessments');
            }, 500);
        }

        function toggleAnswerType(type) {
            const item = document.querySelector(`[data-type="${type}"]`);
            item.classList.toggle('selected');
            
            if (selectedAnswerTypes.includes(type)) {
                selectedAnswerTypes = selectedAnswerTypes.filter(t => t !== type);
            } else {
                selectedAnswerTypes.push(type);
            }

            // Show/hide text limit section
            const textLimitSection = document.getElementById('textLimitSection');
            if (selectedAnswerTypes.includes('text') || selectedAnswerTypes.includes('code')) {
                textLimitSection.style.display = 'block';
            } else {
                textLimitSection.style.display = 'none';
                selectedTextLimit = null;
                document.querySelectorAll('.text-limit-item').forEach(item => {
                    item.classList.remove('selected');
                });
            }
        }

        function selectTextLimit(limit) {
            document.querySelectorAll('.text-limit-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-limit="${limit}"]`).classList.add('selected');
            selectedTextLimit = limit;
        }

        function loadAssessmentsList() {
            console.log('Loading assessments list...');
            const container = document.getElementById('assessmentsList');
            container.innerHTML = '';
            
            console.log('Total assessments to display:', assessments.length);

            if (assessments.length === 0) {
                container.innerHTML = `
                    <div class="question-card">
                        <h4>No Assessments Found</h4>
                        <p>You haven't created any assessments yet.</p>
                        <button class="btn" onclick="showAdminTab('create-assessment')">Create Your First Assessment</button>
                    </div>
                `;
                return;
            }

            assessments.forEach((assessment, index) => {
                console.log(`Rendering assessment ${index + 1}:`, assessment.title);
                
                const assessmentCard = document.createElement('div');
                assessmentCard.className = 'question-card';
                
                const now = new Date();
                const start = new Date(assessment.startDate);
                const end = new Date(assessment.endDate);
                
                let status = 'Scheduled';
                let statusClass = 'status-pending';
                
                if (now >= start && now <= end) {
                    status = 'Active';
                    statusClass = 'status-open';
                } else if (now > end) {
                    status = 'Closed';
                    statusClass = 'status-closed';
                }

                // Generate the assignment button based on current state
                let assignmentButton = '';
                if (!assessment.assignedStudents || assessment.assignedStudents.length === 0) {
                    // Currently assigned to all students - show button to assign to specific students
                    assignmentButton = `<button class="btn btn-success" onclick="assignToSpecificStudents('${assessment.id}')">Assign to Specific Students</button>`;
                } else {
                    // Currently assigned to specific students - show button to assign to all students
                    assignmentButton = `<button class="btn btn-success" onclick="assignToAllStudents('${assessment.id}')">Assign to All Students</button>`;
                }

                assessmentCard.innerHTML = `
                    <div class="question-header">
                        <h4>${assessment.title}</h4>
                        <span class="status-badge ${statusClass}">${status}</span>
                    </div>
                    <p>${assessment.description}</p>
                    <div class="question-meta">
                        <strong>Duration:</strong> ${new Date(assessment.startDate).toLocaleString()} - ${new Date(assessment.endDate).toLocaleString()}<br>
                        <strong>Max Score:</strong> ${assessment.maxScore} points<br>
                        <strong>Questions:</strong> ${assessment.questions ? assessment.questions.length : 0}<br>
                        <strong>Assigned to:</strong> ${
                            !assessment.assignedStudents || assessment.assignedStudents.length === 0 
                            ? '<span style="color: #28a745; font-weight: bold;">ALL STUDENTS</span>' 
                            : assessment.assignedStudents.join(', ')
                        }
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="addQuestionToAssessment('${assessment.id}')">Add Question</button>
                        <button class="btn btn-secondary" onclick="viewAssessmentQuestions('${assessment.id}')">View Questions</button>
                        <button class="btn btn-warning" onclick="editAssessmentStudents('${assessment.id}')">Edit Students</button>
                        <button class="btn btn-success" onclick="activateAssessmentNow('${assessment.id}')">🚀 Activate Now</button>
                        ${assignmentButton}
                        <button class="btn btn-danger" onclick="deleteAssessment('${assessment.id}')">Delete</button>
                    </div>
                `;
                
                container.appendChild(assessmentCard);
            });
            
            console.log('Finished rendering all assessments');
        }

        function editAssessmentStudents(assessmentId) {
            const assessment = assessments.find(a => a.id === assessmentId);
            if (!assessment) return;

            let studentsHtml = `
                <h3>Edit Student Assignment: ${assessment.title}</h3>
                <p style="margin-bottom: 15px;">Current assignment: ${
                    !assessment.assignedStudents || assessment.assignedStudents.length === 0 
                    ? '<span style="color: #28a745; font-weight: bold;">ALL STUDENTS</span>' 
                    : `<span style="color: #007bff; font-weight: bold;">${assessment.assignedStudents.join(', ')}</span>`
                }</p>
                
                <div class="student-selection">
                    <label><strong>Select Students:</strong></label>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Select specific students or leave none selected for ALL students</p>
                    
                    <div class="student-list" id="editStudentList">
            `;

            students.forEach(student => {
                const isAssigned = assessment.assignedStudents && assessment.assignedStudents.includes(student);
                studentsHtml += `
                    <div class="student-item ${isAssigned ? 'selected' : ''}" 
                         data-student="${student}" 
                         onclick="toggleEditStudentSelection('${student}')">
                        ${student}
                    </div>
                `;
            });

            studentsHtml += `
                    </div>
                    
                    <div id="editSelectionSummary" style="margin: 10px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px; font-weight: bold;">
                        ${!assessment.assignedStudents || assessment.assignedStudents.length === 0 
                          ? 'Available to ALL students' 
                          : `Selected: ${assessment.assignedStudents.join(', ')}`}
                    </div>
                    
                    <div style="margin-top: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="selectAllEditStudents()">Select All</button>
                        <button type="button" class="btn btn-secondary" onclick="clearEditStudentSelection()">Clear All (All Students)</button>
                    </div>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
                    <button class="btn" onclick="saveStudentAssignment('${assessmentId}')">Save Changes</button>
                </div>
            `;

            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1001;';
            modal.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 90%; overflow-y: auto;">
                    ${studentsHtml}
                </div>
            `;
            document.body.appendChild(modal);
            
            // Update the summary immediately
            updateEditSelectionSummary();
        }

        function toggleEditStudentSelection(studentName) {
            const item = document.querySelector(`#editStudentList [data-student="${studentName}"]`);
            if (item) {
                item.classList.toggle('selected');
                updateEditSelectionSummary();
            }
        }

        function selectAllEditStudents() {
            document.querySelectorAll('#editStudentList .student-item').forEach(item => {
                item.classList.add('selected');
            });
            updateEditSelectionSummary();
        }

        function clearEditStudentSelection() {
            document.querySelectorAll('#editStudentList .student-item').forEach(item => {
                item.classList.remove('selected');
            });
            updateEditSelectionSummary();
        }

        function updateEditSelectionSummary() {
            const selectedItems = document.querySelectorAll('#editStudentList .student-item.selected');
            const selectedStudents = Array.from(selectedItems).map(item => item.getAttribute('data-student'));
            const summaryElement = document.getElementById('editSelectionSummary');
            
            if (summaryElement) {
                if (selectedStudents.length === 0) {
                    summaryElement.textContent = 'Available to ALL students';
                    summaryElement.style.color = '#28a745';
                } else {
                    summaryElement.textContent = `Selected: ${selectedStudents.join(', ')} (${selectedStudents.length} students)`;
                    summaryElement.style.color = '#007bff';
                }
            }
        }

        function saveStudentAssignment(assessmentId) {
            const assessment = assessments.find(a => a.id === assessmentId);
            const selectedItems = document.querySelectorAll('#editStudentList .student-item.selected');
            const selectedStudents = Array.from(selectedItems).map(item => item.getAttribute('data-student'));
            
            console.log('Saving assignment for assessment:', assessmentId);
            console.log('Selected students:', selectedStudents);
            
            // Set assignment
            if (selectedStudents.length === 0) {
                assessment.assignedStudents = []; // Empty array = all students
                alert(`Assessment "${assessment.title}" is now available to ALL students!`);
            } else {
                assessment.assignedStudents = selectedStudents;
                alert(`Assessment "${assessment.title}" is now assigned to: ${selectedStudents.join(', ')}`);
            }
            
            document.body.lastElementChild.remove();
            loadAssessmentsList();
        }

        function addQuestionToAssessment(assessmentId) {
            currentAssessmentId = assessmentId;
            selectedAnswerTypes = [];
            selectedTextLimit = null;
            document.getElementById('questionModal').style.display = 'block';
        }

        function closeQuestionModal() {
            document.getElementById('questionModal').style.display = 'none';
            
            // Clear form
            document.getElementById('questionText').value = '';
            document.getElementById('questionPoints').value = '10';
            document.getElementById('questionInstructions').value = '';
            
            // Clear selections
            selectedAnswerTypes = [];
            selectedTextLimit = null;
            document.querySelectorAll('.answer-type-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelectorAll('.text-limit-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.getElementById('textLimitSection').style.display = 'none';
        }

        function addQuestion() {
            const text = document.getElementById('questionText').value;
            const points = document.getElementById('questionPoints').value;
            const instructions = document.getElementById('questionInstructions').value;

            if (!text || !points) {
                alert('Please fill in required fields');
                return;
            }

            if (selectedAnswerTypes.length === 0) {
                alert('Please select at least one answer type');
                return;
            }

            const question = {
                id: 'q_' + Date.now(),
                text,
                types: [...selectedAnswerTypes],
                textLimit: selectedTextLimit,
                points: parseInt(points),
                instructions
            };

            const assessment = assessments.find(a => a.id === currentAssessmentId);
            if (assessment) {
                if (!assessment.questions) {
                    assessment.questions = [];
                }
                assessment.questions.push(question);
                updateAdminStats();
                loadAssessmentsList();
            }

            closeQuestionModal();
            alert('Question added successfully!');
        }

        function viewAssessmentQuestions(assessmentId) {
            const assessment = assessments.find(a => a.id === assessmentId);
            if (!assessment || !assessment.questions) {
                alert('No questions found for this assessment');
                return;
            }

            let questionsHtml = `<h3>Questions for: ${assessment.title}</h3>`;
            assessment.questions.forEach((question, index) => {
                questionsHtml += `
                    <div class="question-card">
                        <h4>Question ${index + 1} (${question.points} points)</h4>
                        <p><strong>Answer Types:</strong> ${question.types.join(', ')}</p>
                        ${question.textLimit ? `<p><strong>Text Minimum:</strong> ${question.textLimit} characters</p>` : ''}
                        <p><strong>Question:</strong> ${question.text}</p>
                        ${question.instructions ? `<p><strong>Instructions:</strong> ${question.instructions}</p>` : ''}
                        <button class="btn btn-danger" onclick="deleteQuestion('${assessmentId}', '${question.id}')">Delete Question</button>
                    </div>
                `;
            });

            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1001;';
            modal.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 800px; max-height: 90%; overflow-y: auto;">
                    ${questionsHtml}
                    <button class="btn btn-secondary" onclick="this.parentElement.parentElement.remove()">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function deleteQuestion(assessmentId, questionId) {
            if (confirm('Are you sure you want to delete this question?')) {
                const assessment = assessments.find(a => a.id === assessmentId);
                if (assessment && assessment.questions) {
                    assessment.questions = assessment.questions.filter(q => q.id !== questionId);
                    updateAdminStats();
                    loadAssessmentsList();
                    // Close and reopen the modal to refresh
                    document.body.lastElementChild.remove();
                    viewAssessmentQuestions(assessmentId);
                }
            }
        }

        function activateAssessmentNow(assessmentId) {
            console.log('Activate Now clicked for assessment:', assessmentId);
            
            const assessment = assessments.find(a => a.id === assessmentId);
            if (!assessment) {
                console.error('Assessment not found:', assessmentId);
                alert('Error: Assessment not found!');
                return;
            }
            
            const now = new Date();
            const currentStart = new Date(assessment.startDate);
            const currentEnd = new Date(assessment.endDate);
            
            console.log('Current timing:', {
                now: now.toLocaleString(),
                start: currentStart.toLocaleString(),
                end: currentEnd.toLocaleString()
            });
            
            if (now >= currentStart && now <= currentEnd) {
                alert(`Assessment "${assessment.title}" is already active!\n\nStart: ${currentStart.toLocaleString()}\nEnd: ${currentEnd.toLocaleString()}\nCurrent: ${now.toLocaleString()}`);
                return;
            }
            
            if (confirm(`Activate "${assessment.title}" immediately?\n\nThis will:\n• Set start time to NOW\n• Keep the same end time\n• Make it available to students immediately`)) {
                console.log('User confirmed activation');
                
                // Set start time to now (1 minute ago to ensure it's definitely active)
                assessment.startDate = new Date(now.getTime() - 60000).toISOString();
                
                console.log('New timing:', {
                    start: new Date(assessment.startDate).toLocaleString(),
                    end: new Date(assessment.endDate).toLocaleString()
                });
                
                // Update the UI
                loadAssessmentsList();
                
                alert(`✅ Assessment "${assessment.title}" is now ACTIVE!\n\nStudents can immediately start taking this assessment.\n\nNew start time: ${new Date(assessment.startDate).toLocaleString()}`);
                console.log('Assessment activation completed');
            } else {
                console.log('User cancelled activation');
            }
        }

        function assignToAllStudents(assessmentId) {
            console.log('Assign to All Students clicked for assessment:', assessmentId);
            
            const assessment = assessments.find(a => a.id === assessmentId);
            if (!assessment) {
                console.error('Assessment not found:', assessmentId);
                alert('Error: Assessment not found!');
                return;
            }
            
            console.log('Current assignment:', assessment.assignedStudents);
            
            // Create a custom confirmation modal instead of using browser confirm()
            showAssignAllStudentsConfirmation(assessmentId, assessment.title, assessment.assignedStudents);
        }

        function showAssignAllStudentsConfirmation(assessmentId, assessmentTitle, currentAssignment) {
            // Create modal HTML
            const modalHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                        <h3 style="color: #28a745; margin-bottom: 20px;">🌍 Assign to All Students</h3>
                        <p style="margin-bottom: 20px; font-size: 16px;">
                            Make <strong>"${assessmentTitle}"</strong> available to ALL students?
                        </p>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                            <p style="margin: 0; font-weight: bold; color: #155724;">Current Assignment:</p>
                            <p style="margin: 5px 0; color: #721c24;">
                                ${currentAssignment && currentAssignment.length > 0 ? 
                                  `Specific students: ${currentAssignment.join(', ')}` : 
                                  'Already assigned to all students'}
                            </p>
                            <p style="margin: 10px 0 0 0; font-weight: bold; color: #155724;">After Change:</p>
                            <p style="margin: 5px 0; color: #155724;">
                                ✅ Available to ALL students (any username can access)
                            </p>
                        </div>
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button class="btn btn-secondary" onclick="cancelAssignAllStudents()" style="min-width: 100px;">Cancel</button>
                            <button class="btn btn-success" onclick="confirmAssignAllStudents('${assessmentId}', '${assessmentTitle}')" style="min-width: 100px;">Assign to All</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            const modal = document.createElement('div');
            modal.id = 'assignAllStudentsModal';
            modal.innerHTML = modalHTML;
            document.body.appendChild(modal);
        }

        function cancelAssignAllStudents() {
            console.log('Assignment to all students cancelled by user');
            const modal = document.getElementById('assignAllStudentsModal');
            if (modal) {
                modal.remove();
            }
        }

        function confirmAssignAllStudents(assessmentId, assessmentTitle) {
            console.log('User confirmed assignment to all students, proceeding...');
            
            // Remove the confirmation modal
            const modal = document.getElementById('assignAllStudentsModal');
            if (modal) {
                modal.remove();
            }
            
            try {
                const assessment = assessments.find(a => a.id === assessmentId);
                if (!assessment) {
                    console.error('Assessment not found during confirmation:', assessmentId);
                    alert('Error: Assessment not found!');
                    return;
                }
                
                console.log('Before assignment - current assignment:', assessment.assignedStudents);
                
                // Set to empty array to indicate all students
                assessment.assignedStudents = [];
                
                console.log('After assignment - new assignment:', assessment.assignedStudents);
                
                // Update the UI
                loadAssessmentsList();
                
                alert(`✅ Assessment "${assessmentTitle}" is now available to ALL students!\n\nAny student who logs in can now see and take this assessment.`);
                console.log('Assignment to all students completed successfully');
                
            } catch (error) {
                console.error('Error during assignment to all students:', error);
                alert('❌ An error occurred while assigning to all students. Please try again.');
            }
        }

        function assignToSpecificStudents(assessmentId) {
            console.log('Assign to Specific Students clicked for assessment:', assessmentId);
            editAssessmentStudents(assessmentId);
        }

        function refreshAssessmentsList() {
            console.log('Manual refresh triggered');
            updateAdminStats();
            loadAssessmentsList();
            alert('Assessment list refreshed!');
        }

        function testAssignmentButtons() {
            console.log('=== TESTING ASSIGNMENT BUTTONS ===');
            
            let testInfo = `ASSIGNMENT BUTTON TEST:\n\n`;
            testInfo += `Total Assessments: ${assessments.length}\n\n`;
            
            assessments.forEach((assessment, index) => {
                testInfo += `${index + 1}. "${assessment.title}"\n`;
                testInfo += `   ID: ${assessment.id}\n`;
                
                if (!assessment.assignedStudents || assessment.assignedStudents.length === 0) {
                    testInfo += `   Assignment: ALL STUDENTS\n`;
                    testInfo += `   Button: "Assign to Specific Students"\n`;
                } else {
                    testInfo += `   Assignment: SPECIFIC STUDENTS\n`;
                    testInfo += `   Students: ${assessment.assignedStudents.join(', ')}\n`;
                    testInfo += `   Button: "Assign to All Students"\n`;
                }
                testInfo += `\n`;
            });
            
            alert(testInfo);
        }

        function debugAssessments() {
            console.log('=== ADMIN DEBUG INFO ===');
            console.log('Total assessments:', assessments.length);
            console.log('Assessments array:', assessments);
            console.log('Total submissions:', submissions.length);
            console.log('Submissions array:', submissions);
            console.log('Current user:', currentUser);
            console.log('Students list:', students);
            
            let debugInfo = `ADMIN DEBUG INFORMATION:\n\n`;
            debugInfo += `Total Assessments: ${assessments.length}\n`;
            debugInfo += `Total Submissions: ${submissions.length}\n`;
            debugInfo += `Current User: ${currentUser ? currentUser.username : 'None'}\n`;
            debugInfo += `Total Students: ${students.length}\n\n`;
            
            if (assessments.length > 0) {
                debugInfo += `Assessment Details:\n`;
                assessments.forEach((assessment, index) => {
                    debugInfo += `${index + 1}. "${assessment.title}" (ID: ${assessment.id})\n`;
                    debugInfo += `   - Questions: ${assessment.questions ? assessment.questions.length : 0}\n`;
                    if (!assessment.assignedStudents || assessment.assignedStudents.length === 0) {
                        debugInfo += `   - Assigned to: ALL STUDENTS\n\n`;
                    } else {
                        debugInfo += `   - Assigned to: ${assessment.assignedStudents.length} specific students\n`;
                        debugInfo += `     (${assessment.assignedStudents.join(', ')})\n\n`;
                    }
                });
            }
            
            alert(debugInfo);
        }

        function clearAndReload() {
            console.log('=== CLEARING AND RELOADING DATA ===');
            
            // Clear all data and reinitialize
            assessments = [];
            submissions = [];
            
            // Reinitialize sample data
            initializeSampleData();
            
            // Reload assessments
            loadStudentAssessments();
            
            alert('Data cleared and reloaded! You should now see the demo assessment.');
        }

        function refreshStudentAssessments() {
            console.log('Student assessment refresh triggered');
            loadStudentAssessments();
            alert('Assessment list refreshed!');
        }

        function checkAssessmentTiming() {
            console.log('=== ASSESSMENT TIMING CHECK ===');
            const now = new Date();
            
            let timingInfo = `ASSESSMENT TIMING INFORMATION:\n\n`;
            timingInfo += `Current Time: ${now.toLocaleString()}\n\n`;
            
            if (assessments.length === 0) {
                timingInfo += `No assessments found in the system.`;
                alert(timingInfo);
                return;
            }
            
            assessments.forEach((assessment, index) => {
                const start = new Date(assessment.startDate);
                const end = new Date(assessment.endDate);
                
                timingInfo += `${index + 1}. "${assessment.title}"\n`;
                timingInfo += `   Start: ${start.toLocaleString()}\n`;
                timingInfo += `   End: ${end.toLocaleString()}\n`;
                
                if (now < start) {
                    const timeUntilStart = start - now;
                    const minutesUntilStart = Math.ceil(timeUntilStart / (1000 * 60));
                    const hoursUntilStart = Math.floor(minutesUntilStart / 60);
                    
                    if (hoursUntilStart > 0) {
                        timingInfo += `   Status: ⏳ Starts in ${hoursUntilStart}h ${minutesUntilStart % 60}m\n`;
                    } else {
                        timingInfo += `   Status: ⏳ Starts in ${minutesUntilStart} minutes\n`;
                    }
                    timingInfo += `   Action: Wait or ask admin to activate early\n`;
                } else if (now >= start && now <= end) {
                    timingInfo += `   Status: ✅ ACTIVE - You can take this assessment\n`;
                    timingInfo += `   Action: Click "Take Assessment" button\n`;
                } else {
                    timingInfo += `   Status: ❌ EXPIRED - Assessment has ended\n`;
                    timingInfo += `   Action: Contact admin to extend deadline\n`;
                }
                timingInfo += `\n`;
            });
            
            // Check if student can see any assessments
            const myAssessments = assessments.filter(assessment => {
                return !assessment.assignedStudents || 
                       assessment.assignedStudents.length === 0 || 
                       assessment.assignedStudents.includes(currentUser.username);
            });
            
            timingInfo += `\n📊 SUMMARY:\n`;
            timingInfo += `Total assessments in system: ${assessments.length}\n`;
            timingInfo += `Assessments you can see: ${myAssessments.length}\n`;
            
            const activeAssessments = myAssessments.filter(a => {
                const start = new Date(a.startDate);
                const end = new Date(a.endDate);
                return now >= start && now <= end;
            });
            
            timingInfo += `Active assessments you can take: ${activeAssessments.length}\n`;
            
            if (activeAssessments.length === 0 && myAssessments.length > 0) {
                timingInfo += `\n💡 TIP: All your assessments are either not started yet or have ended. Ask admin to adjust timing.`;
            }
            
            alert(timingInfo);
        }

        function createTestAssessment() {
            console.log('Creating test assessment for current student...');
            
            const testAssessment = {
                id: 'test_assessment_' + Date.now(),
                title: `Test Assessment for ${currentUser.username}`,
                description: `This assessment was created specifically for student "${currentUser.username}" and is ACTIVE NOW.`,
                startDate: new Date(Date.now() - 3600000).toISOString(), // Started 1 hour ago
                endDate: new Date(Date.now() + 7 * 86400000).toISOString(), // Ends in 7 days
                maxScore: 50,
                createdBy: 'system',
                assignedStudents: [], // Empty = available to ALL students
                questions: [
                    {
                        id: 'test_q1_' + Date.now(),
                        text: 'This is a test question. What is your name?',
                        types: ['text'],
                        textLimit: 10,
                        points: 25,
                        instructions: 'Just enter your name to test the system.'
                    },
                    {
                        id: 'test_q2_' + Date.now(),
                        text: 'Upload any file and provide any URL link.',
                        types: ['file', 'url'],
                        points: 25,
                        instructions: 'This tests multiple answer types.'
                    }
                ]
            };
            
            assessments.push(testAssessment);
            loadStudentAssessments();
            
            alert(`✅ Created test assessment "${testAssessment.title}"!\n\nThis assessment is ACTIVE NOW and available to ALL students.`);
        }

        function debugStudentInfo() {
            console.log('=== STUDENT DEBUG INFO ===');
            console.log('Current student username:', currentUser.username);
            console.log('Total assessments available:', assessments.length);
            console.log('Students list:', students);
            
            let debugInfo = `STUDENT DEBUG INFORMATION:\n\n`;
            debugInfo += `Your Username: "${currentUser.username}"\n`;
            debugInfo += `Total Assessments in System: ${assessments.length}\n\n`;
            
            if (assessments.length > 0) {
                debugInfo += `Assessment Details:\n`;
                assessments.forEach((assessment, index) => {
                    debugInfo += `${index + 1}. "${assessment.title}"\n`;
                    
                    if (!assessment.assignedStudents || assessment.assignedStudents.length === 0) {
                        debugInfo += `   ✅ Available to ALL students\n`;
                        debugInfo += `   → You SHOULD see this assessment\n`;
                    } else {
                        debugInfo += `   👥 Assigned to specific students: ${assessment.assignedStudents.join(', ')}\n`;
                        
                        // Check if current user is in the list
                        if (assessment.assignedStudents.includes(currentUser.username)) {
                            debugInfo += `   ✅ You ARE assigned to this assessment\n`;
                            debugInfo += `   → You SHOULD see this assessment\n`;
                        } else {
                            debugInfo += `   ❌ You are NOT assigned to this assessment\n`;
                            debugInfo += `   → You will NOT see this assessment\n`;
                            debugInfo += `   💡 To see it: Login as one of these usernames: ${assessment.assignedStudents.join(', ')}\n`;
                        }
                    }
                    debugInfo += `\n`;
                });
                
                debugInfo += `\n💡 SOLUTIONS:\n`;
                debugInfo += `1. Login as a matching username above\n`;
                debugInfo += `2. Ask admin to "Assign to All Students"\n`;
                debugInfo += `3. Click "Create Test Assessment" below\n`;
            } else {
                debugInfo += `No assessments found in the system.\n`;
                debugInfo += `Ask an administrator to create assessments.`;
            }
            
            alert(debugInfo);
        }

        function deleteAssessment(assessmentId) {
            console.log('Delete button clicked for assessment:', assessmentId);
            
            // Find the assessment to get its title
            const assessmentToDelete = assessments.find(a => a.id === assessmentId);
            if (!assessmentToDelete) {
                console.error('Assessment not found:', assessmentId);
                alert('Error: Assessment not found!');
                return;
            }

            const assessmentTitle = assessmentToDelete.title;
            console.log('Found assessment to delete:', assessmentTitle);
            
            // Create a custom confirmation modal instead of using browser confirm()
            showDeleteConfirmation(assessmentId, assessmentTitle);
        }

        function showDeleteConfirmation(assessmentId, assessmentTitle) {
            // Create modal HTML
            const modalHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                        <h3 style="color: #dc3545; margin-bottom: 20px;">⚠️ Confirm Deletion</h3>
                        <p style="margin-bottom: 20px; font-size: 16px;">
                            Are you sure you want to delete<br>
                            <strong>"${assessmentTitle}"</strong>?
                        </p>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                            <p style="margin: 0; font-weight: bold; color: #721c24;">This will permanently remove:</p>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>The entire assessment</li>
                                <li>All student submissions</li>
                                <li>All grades and scores</li>
                            </ul>
                            <p style="margin: 0; font-weight: bold; color: #721c24;">This action cannot be undone!</p>
                        </div>
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button class="btn btn-secondary" onclick="cancelDelete()" style="min-width: 100px;">Cancel</button>
                            <button class="btn btn-danger" onclick="confirmDelete('${assessmentId}', '${assessmentTitle}')" style="min-width: 100px;">Delete</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            const modal = document.createElement('div');
            modal.id = 'deleteConfirmationModal';
            modal.innerHTML = modalHTML;
            document.body.appendChild(modal);
        }

        function cancelDelete() {
            console.log('Deletion cancelled by user');
            const modal = document.getElementById('deleteConfirmationModal');
            if (modal) {
                modal.remove();
            }
        }

        function confirmDelete(assessmentId, assessmentTitle) {
            console.log('User confirmed deletion, proceeding...');
            
            // Remove the confirmation modal
            const modal = document.getElementById('deleteConfirmationModal');
            if (modal) {
                modal.remove();
            }
            
            try {
                // Remove assessment
                const originalLength = assessments.length;
                console.log('Before deletion - assessments count:', originalLength);
                
                assessments = assessments.filter(a => a.id !== assessmentId);
                
                console.log('After deletion - assessments count:', assessments.length);
                
                if (assessments.length === originalLength) {
                    console.error('Assessment was not removed from array');
                    alert('Error: Failed to delete assessment');
                    return;
                }
                
                console.log('Successfully removed assessment from array');
                
                // Remove related submissions
                const originalSubmissions = submissions.length;
                submissions = submissions.filter(s => s.assessmentId !== assessmentId);
                console.log('Submissions: was', originalSubmissions, 'now', submissions.length);
                
                // Update UI immediately
                updateAdminStats();
                loadAssessmentsList();
                
                // Show success message
                alert(`✅ Assessment "${assessmentTitle}" has been deleted successfully!`);
                console.log('Deletion completed successfully');
                
            } catch (error) {
                console.error('Error during deletion:', error);
                alert('❌ An error occurred while deleting the assessment. Please try again.');
            }
        }

        function loadSubmissionsList() {
            console.log('=== LOADING SUBMISSIONS FOR ADMIN ===');
            const container = document.getElementById('submissionsList');
            container.innerHTML = '';

            console.log('Total submissions in system:', submissions.length);
            console.log('All submissions:', submissions);

            submissions.forEach((submission, index) => {
                console.log(`Submission ${index + 1}:`, submission);
                
                const assessment = assessments.find(a => a.id === submission.assessmentId);
                if (!assessment) {
                    console.log('Assessment not found for submission:', submission.assessmentId);
                    return;
                }

                const submissionCard = document.createElement('div');
                submissionCard.className = 'question-card';
                
                const answerCount = submission.answers ? Object.keys(submission.answers).length : 0;
                const isDraft = submission.isDraft ? true : false;
                
                submissionCard.innerHTML = `
                    <div class="question-header">
                        <h4>${assessment.title} - ${submission.studentName}</h4>
                        <span class="status-badge ${submission.graded ? 'status-open' : 'status-pending'}">
                            ${submission.graded ? 'Graded' : 'Pending'}
                        </span>
                    </div>
                    <div class="question-meta">
                        <strong>Submitted:</strong> ${new Date(submission.submittedAt).toLocaleString()}<br>
                        <strong>Status:</strong> ${isDraft ? 'Draft' : 'Final Submission'}<br>
                        <strong>Answers:</strong> ${answerCount} questions answered<br>
                        <strong>Score:</strong> ${submission.score || 'Not graded'} / ${assessment.maxScore}<br>
                        <strong>Submission ID:</strong> ${submission.id}
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="gradeSubmission('${submission.id}')">Grade Submission</button>
                        <button class="btn btn-secondary" onclick="debugSubmissionAnswers('${submission.id}')">🐛 Debug Answers</button>
                    </div>
                `;
                
                container.appendChild(submissionCard);
            });

            if (submissions.length === 0) {
                container.innerHTML = `
                    <div class="question-card">
                        <h4>No Submissions Found</h4>
                        <p>There are currently no student submissions in the system.</p>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="debugAllSubmissions()">🐛 Debug All Data</button>
                        </div>
                    </div>
                `;
            }
        }

        function debugSubmissionAnswers(submissionId) {
            console.log('=== DEBUGGING SUBMISSION ANSWERS ===');
            
            const submission = submissions.find(s => s.id === submissionId);
            if (!submission) {
                alert('❌ Submission not found!');
                return;
            }
            
            const assessment = assessments.find(a => a.id === submission.assessmentId);
            
            let debugInfo = `SUBMISSION DEBUG:\n\n`;
            debugInfo += `Submission ID: ${submission.id}\n`;
            debugInfo += `Student: ${submission.studentName}\n`;
            debugInfo += `Assessment: ${assessment ? assessment.title : 'Unknown'}\n`;
            debugInfo += `Submitted: ${new Date(submission.submittedAt).toLocaleString()}\n`;
            debugInfo += `Is Draft: ${submission.isDraft ? 'Yes' : 'No'}\n\n`;
            
            debugInfo += `ANSWERS DATA:\n`;
            if (submission.answers && Object.keys(submission.answers).length > 0) {
                Object.entries(submission.answers).forEach(([questionId, answerData]) => {
                    debugInfo += `\nQuestion: ${questionId}\n`;
                    if (typeof answerData === 'object') {
                        Object.entries(answerData).forEach(([type, answer]) => {
                            debugInfo += `  ${type}: ${answer}\n`;
                        });
                    } else {
                        debugInfo += `  Answer: ${answerData}\n`;
                    }
                });
            } else {
                debugInfo += `❌ No answers found in submission!\n`;
            }
            
            console.log('Submission details:', submission);
            alert(debugInfo);
        }

        function debugAllSubmissions() {
            console.log('=== DEBUGGING ALL SUBMISSIONS ===');
            
            let debugInfo = `ALL SUBMISSIONS DEBUG:\n\n`;
            debugInfo += `Total Submissions: ${submissions.length}\n`;
            debugInfo += `Total Assessments: ${assessments.length}\n\n`;
            
            if (submissions.length === 0) {
                debugInfo += `No submissions found. Possible issues:\n`;
                debugInfo += `1. Students haven't submitted anything\n`;
                debugInfo += `2. Submission process isn't working\n`;
                debugInfo += `3. Data isn't being saved properly\n`;
            } else {
                submissions.forEach((submission, index) => {
                    debugInfo += `${index + 1}. ${submission.studentName} - ${submission.id}\n`;
                    debugInfo += `   Assessment: ${submission.assessmentId}\n`;
                    debugInfo += `   Answers: ${submission.answers ? Object.keys(submission.answers).length : 0}\n`;
                    debugInfo += `   Draft: ${submission.isDraft ? 'Yes' : 'No'}\n\n`;
                });
            }
            
            console.log('All submissions:', submissions);
            console.log('All assessments:', assessments);
            alert(debugInfo);
        }

        function gradeSubmission(submissionId) {
            console.log('=== GRADING SUBMISSION ===');
            console.log('Submission ID:', submissionId);
            
            const submission = submissions.find(s => s.id === submissionId);
            const assessment = assessments.find(a => a.id === submission.assessmentId);
            
            if (!submission || !assessment) {
                alert('❌ Submission or assessment not found');
                return;
            }

            console.log('Found submission:', submission);
            console.log('Found assessment:', assessment);
            console.log('Submission answers:', submission.answers);
            console.log('Raw submission object:', JSON.stringify(submission, null, 2));
            
            let gradingHtml = `
                <h3>Grade Submission: ${assessment.title}</h3>
                <p><strong>Student:</strong> ${submission.studentName}</p>
                <p><strong>Submitted:</strong> ${new Date(submission.submittedAt).toLocaleString()}</p>
                <p><strong>Submission ID:</strong> ${submission.id}</p>
                <div style="max-height: 400px; overflow-y: auto; margin: 20px 0;">
            `;

            assessment.questions.forEach((question, index) => {
                const questionNum = index + 1;
                console.log(`\n--- Processing question ${questionNum}: ${question.id} ---`);
                console.log('Question text:', question.text);
                console.log('Question types:', question.types);
                
                // IMPROVED ANSWER RETRIEVAL - Same logic as saveProgress but for reading
                let questionAnswers = null;
                let foundAnswerMethod = 'none';
                
                // Method 1: Look in the correct nested format (preferred)
                if (submission.answers && submission.answers[question.id]) {
                    questionAnswers = submission.answers[question.id];
                    foundAnswerMethod = 'nested_format';
                    console.log('✅ Found answers in nested format:', questionAnswers);
                }
                
                // Method 2: If not found, create from flat field structure (fallback)
                if (!questionAnswers && submission.answers) {
                    const fieldAnswers = {};
                    let foundFieldAnswers = false;
                    
                    question.types.forEach(type => {
                        const fieldName = `${question.id}_${type}`;
                        if (submission.answers[fieldName]) {
                            fieldAnswers[type] = submission.answers[fieldName];
                            foundFieldAnswers = true;
                            console.log(`✅ Found ${type} answer in field ${fieldName}:`, submission.answers[fieldName]);
                        }
                    });
                    
                    if (foundFieldAnswers) {
                        questionAnswers = fieldAnswers;
                        foundAnswerMethod = 'field_format';
                    }
                }
                
                console.log(`Final questionAnswers for Q${questionNum}:`, questionAnswers);
                console.log(`Answer retrieval method: ${foundAnswerMethod}`);
                
                gradingHtml += `
                    <div class="question-card">
                        <h4>Question ${questionNum} (${question.points} points)</h4>
                        <p><strong>Question:</strong> ${question.text}</p>
                        <p><strong>Expected Answer Types:</strong> ${question.types ? question.types.join(', ') : 'Not specified'}</p>
                        <p style="font-size: 12px; color: #666;"><strong>Question ID:</strong> ${question.id} | <strong>Retrieval Method:</strong> ${foundAnswerMethod}</p>
                        <div class="answer-display">
                            <strong>Student Answers:</strong><br>
                `;
                
                // Display answers based on what we found
                if (questionAnswers && typeof questionAnswers === 'object' && Object.keys(questionAnswers).length > 0) {
                    // Multiple answer types (object format) - this is the correct format
                    Object.entries(questionAnswers).forEach(([type, answer]) => {
                        if (answer && answer.toString().trim()) {
                            gradingHtml += formatAnswerForGrading(answer, type, type);
                            console.log(`✅ Displayed ${type} answer:`, answer.substring(0, 50) + '...');
                        }
                    });
                } else if (questionAnswers && typeof questionAnswers === 'string' && questionAnswers.trim()) {
                    // Single answer (string format) - legacy support
                    gradingHtml += formatAnswerForGrading(questionAnswers, 'text', 'Answer');
                    console.log(`✅ Displayed legacy string answer:`, questionAnswers.substring(0, 50) + '...');
                } else {
                    // No answers found - show comprehensive debug info
                    gradingHtml += `
                        <div style="color: #dc3545; font-style: italic; background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #dc3545;">
                            <p><strong>⚠️ No answer found for this question</strong></p>
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; font-weight: bold;">Debug Information</summary>
                                <div style="margin-top: 10px; font-size: 12px; font-family: monospace;">
                                    <p><strong>Question ID:</strong> ${question.id}</p>
                                    <p><strong>Expected Types:</strong> ${question.types.join(', ')}</p>
                                    <p><strong>Expected Field Names:</strong> ${question.types.map(t => `${question.id}_${t}`).join(', ')}</p>
                                    <p><strong>Available Answer Keys:</strong> ${submission.answers ? Object.keys(submission.answers).join(', ') : 'None'}</p>
                                    <p><strong>Submission Has Answers Object:</strong> ${submission.answers ? 'Yes' : 'No'}</p>
                                    ${submission.answers ? `<p><strong>Total Answers in Submission:</strong> ${Object.keys(submission.answers).length}</p>` : ''}
                                </div>
                            </details>
                        </div>
                    `;
                    console.log(`❌ No answer found for question ${question.id}`);
                    console.log('Available keys in submission.answers:', submission.answers ? Object.keys(submission.answers) : 'No answers object');
                }
                
                gradingHtml += `
                        </div>
                        <div style="margin-top: 10px;">
                            <label><strong>Score:</strong></label>
                            <input type="number" class="score-input" max="${question.points}" min="0" 
                                   value="${submission.scores ? submission.scores[question.id] || 0 : 0}" 
                                   data-question-id="${question.id}">
                            / ${question.points} points
                        </div>
                    </div>
                `;
            });

            gradingHtml += `
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="debugSubmissionData('${submissionId}')">🐛 Debug Submission Data</button>
                    <button class="btn btn-warning" onclick="fixSubmissionAnswers('${submissionId}')">🔧 Fix Answer Structure</button>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
                    <button class="btn" onclick="saveGrades('${submissionId}')">Save Grades</button>
                </div>
            `;

            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1001;';
            modal.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 95%; max-width: 900px; max-height: 90%; overflow-y: auto;">
                    ${gradingHtml}
                </div>
            `;
            document.body.appendChild(modal);
        }

        function formatAnswerForGrading(answer, type, label) {
            if (!answer) return `<p><strong>${label}:</strong> <em>No answer provided</em></p>`;
            
            let formattedAnswer = '';
            
            switch(type.toLowerCase()) {
                case 'text':
                case 'code':
                    formattedAnswer = `
                        <div style="margin-bottom: 15px;">
                            <p><strong>${label.toUpperCase()}:</strong></p>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; white-space: pre-wrap; font-family: ${type === 'code' ? 'monospace' : 'inherit'};">
                                ${answer}
                            </div>
                            <small style="color: #666;">Length: ${answer.length} characters</small>
                        </div>
                    `;
                    break;
                case 'file':
                    formattedAnswer = `
                        <div style="margin-bottom: 15px;">
                            <p><strong>FILE UPLOAD:</strong></p>
                            <div style="background: #e3f2fd; padding: 10px; border-radius: 5px;">
                                📎 ${answer}
                            </div>
                        </div>
                    `;
                    break;
                case 'url':
                    formattedAnswer = `
                        <div style="margin-bottom: 15px;">
                            <p><strong>URL LINK:</strong></p>
                            <div style="background: #e8f5e8; padding: 10px; border-radius: 5px;">
                                🔗 <a href="${answer}" target="_blank">${answer}</a>
                            </div>
                        </div>
                    `;
                    break;
                case 'voice':
                    formattedAnswer = `
                        <div style="margin-bottom: 15px;">
                            <p><strong>VOICE RECORDING:</strong></p>
                            <div style="background: #fff3cd; padding: 10px; border-radius: 5px;">
                                🎤 ${answer}
                            </div>
                        </div>
                    `;
                    break;
                default:
                    formattedAnswer = `
                        <div style="margin-bottom: 15px;">
                            <p><strong>${label.toUpperCase()}:</strong></p>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                                ${answer}
                            </div>
                        </div>
                    `;
            }
            
            return formattedAnswer;
        }

        function debugSubmissionData(submissionId) {
            console.log('=== DEBUGGING SUBMISSION DATA ===');
            
            const submission = submissions.find(s => s.id === submissionId);
            if (!submission) {
                alert('❌ Submission not found!');
                return;
            }
            
            let debugInfo = `DETAILED SUBMISSION DEBUG:\n\n`;
            debugInfo += `Submission ID: ${submission.id}\n`;
            debugInfo += `Student: ${submission.studentName}\n`;
            debugInfo += `Assessment ID: ${submission.assessmentId}\n`;
            debugInfo += `Submitted: ${submission.submittedAt}\n`;
            debugInfo += `Is Draft: ${submission.isDraft}\n\n`;
            
            debugInfo += `RAW ANSWERS DATA:\n`;
            debugInfo += `Type: ${typeof submission.answers}\n`;
            debugInfo += `Keys: ${submission.answers ? Object.keys(submission.answers).join(', ') : 'None'}\n\n`;
            
            if (submission.answers) {
                debugInfo += `DETAILED ANSWERS:\n`;
                Object.entries(submission.answers).forEach(([key, value]) => {
                    debugInfo += `\n"${key}": `;
                    if (typeof value === 'object') {
                        debugInfo += `\n  Type: object\n`;
                        Object.entries(value).forEach(([subKey, subValue]) => {
                            debugInfo += `  "${subKey}": "${subValue}"\n`;
                        });
                    } else {
                        debugInfo += `"${value}"\n`;
                    }
                });
            } else {
                debugInfo += `❌ No answers object found!\n`;
            }
            
            console.log('Full submission object:', submission);
            alert(debugInfo);
        }

        function fixSubmissionAnswers(submissionId) {
            console.log('=== FIXING SUBMISSION ANSWER STRUCTURE ===');
            
            const submission = submissions.find(s => s.id === submissionId);
            const assessment = assessments.find(a => a.id === submission.assessmentId);
            
            if (!submission || !assessment) {
                alert('❌ Submission or assessment not found!');
                return;
            }
            
            console.log('Original answers structure:', submission.answers);
            
            if (!submission.answers) {
                alert('❌ No answers found in submission to fix!');
                return;
            }
            
            // Create a new properly structured answers object
            const fixedAnswers = {};
            let changesCount = 0;
            
            assessment.questions.forEach(question => {
                console.log(`\n--- Fixing answers for question: ${question.id} ---`);
                
                // Initialize the question answers object
                const questionAnswers = {};
                let foundAnyAnswer = false;
                
                // Look for answers in various formats
                question.types.forEach(type => {
                    const fieldName = `${question.id}_${type}`;
                    
                    // Check if answer exists in field format
                    if (submission.answers[fieldName]) {
                        questionAnswers[type] = submission.answers[fieldName];
                        foundAnyAnswer = true;
                        changesCount++;
                        console.log(`✅ Found ${type} answer in field format:`, submission.answers[fieldName]);
                    }
                    // Check if answer exists in direct question ID (for single type questions)
                    else if (question.types.length === 1 && submission.answers[question.id]) {
                        questionAnswers[type] = submission.answers[question.id];
                        foundAnyAnswer = true;
                        changesCount++;
                        console.log(`✅ Found answer in direct question ID format:`, submission.answers[question.id]);
                    }
                });
                
                // If we found answers for this question, add them to the fixed structure
                if (foundAnyAnswer) {
                    fixedAnswers[question.id] = questionAnswers;
                    console.log(`✅ Fixed structure for question ${question.id}:`, questionAnswers);
                } else {
                    console.log(`⚠️ No answers found for question ${question.id}`);
                }
            });
            
            console.log('Fixed answers structure:', fixedAnswers);
            console.log('Total changes made:', changesCount);
            
            if (changesCount > 0) {
                // Update the submission with fixed structure
                submission.answers = fixedAnswers;
                submission.lastModified = new Date().toISOString();
                
                // Close current modal and reopen with fixed data
                document.body.lastElementChild.remove();
                
                alert(`✅ Fixed ${changesCount} answer mappings!\n\nThe grading interface will now reload with the corrected answer structure.`);
                
                // Reopen grading modal with fixed data
                setTimeout(() => {
                    gradeSubmission(submissionId);
                }, 500);
                
                console.log('Answer structure fixed and grading modal reopened');
            } else {
                alert('⚠️ No answer structure issues found to fix.\n\nThe submission may have a different issue or the answers may be missing entirely.');
            }
        }

        function formatMultipleAnswers(answers, types) {
            if (!answers || Object.keys(answers).length === 0) {
                return 'No answers provided';
            }
            
            let formattedAnswers = '';
            types.forEach(type => {
                if (answers[type]) {
                    formattedAnswers += `<div style="margin-bottom: 10px;"><strong>${type.toUpperCase()}:</strong><br>`;
                    formattedAnswers += formatAnswer(answers[type], type) + '</div>';
                }
            });
            
            return formattedAnswers || 'No answers provided';
        }

        function formatAnswer(answer, type) {
            if (!answer) return 'No answer provided';
            
            switch(type) {
                case 'text':
                case 'code':
                    return `<pre style="white-space: pre-wrap; background: #f8f9fa; padding: 10px; border-radius: 5px;">${answer}</pre>`;
                case 'file':
                    return `<p>File uploaded: ${answer}</p>`;
                case 'url':
                    return `<a href="${answer}" target="_blank">${answer}</a>`;
                case 'voice':
                    return `<p>Voice recording: ${answer}</p>`;
                default:
                    return answer;
            }
        }

        function saveGrades(submissionId) {
            const submission = submissions.find(s => s.id === submissionId);
            const modal = document.body.lastElementChild;
            const scoreInputs = modal.querySelectorAll('.score-input');
            
            submission.scores = {};
            let totalScore = 0;

            scoreInputs.forEach(input => {
                const questionId = input.getAttribute('data-question-id');
                const score = parseInt(input.value) || 0;
                submission.scores[questionId] = score;
                totalScore += score;
            });

            submission.score = totalScore;
            submission.graded = true;
            submission.gradedAt = new Date().toISOString();

            modal.remove();
            loadSubmissionsList();
            alert('Grades saved successfully!');
        }

        function loadResultsList() {
            const container = document.getElementById('resultsList');
            container.innerHTML = '';

            const gradedSubmissions = submissions.filter(s => s.graded);

            gradedSubmissions.forEach(submission => {
                const assessment = assessments.find(a => a.id === submission.assessmentId);
                if (!assessment) return;

                const resultCard = document.createElement('div');
                resultCard.className = 'question-card';
                
                const percentage = ((submission.score / assessment.maxScore) * 100).toFixed(1);
                
                resultCard.innerHTML = `
                    <div class="question-header">
                        <h4>${assessment.title} - ${submission.studentName}</h4>
                        <span class="status-badge status-open">${percentage}%</span>
                    </div>
                    <div class="question-meta">
                        <strong>Score:</strong> ${submission.score} / ${assessment.maxScore}<br>
                        <strong>Submitted:</strong> ${new Date(submission.submittedAt).toLocaleString()}<br>
                        <strong>Graded:</strong> ${new Date(submission.gradedAt).toLocaleString()}
                    </div>
                `;
                
                container.appendChild(resultCard);
            });

            if (gradedSubmissions.length === 0) {
                container.innerHTML = '<p>No graded submissions yet.</p>';
            }
        }

        // Student Dashboard Functions
        function showStudentTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'available-assessments') {
                loadStudentAssessments();
            } else if (tabName === 'my-submissions') {
                loadMySubmissions();
            } else if (tabName === 'results') {
                loadMyResults();
            }
        }

        function loadStudentDashboard() {
            loadStudentAssessments();
        }

        function loadStudentAssessments() {
            const container = document.getElementById('studentAssessmentsList');
            container.innerHTML = '';

            console.log('=== STUDENT ASSESSMENT LOADING ===');
            console.log('Loading assessments for student:', currentUser.username);
            console.log('Total assessments available:', assessments.length);

            const now = new Date();
            
            // More flexible assessment filtering
            const myAssessments = assessments.filter(assessment => {
                console.log(`\n--- Checking assessment: "${assessment.title}" ---`);
                console.log('Assigned to:', assessment.assignedStudents);
                
                // Case 1: No assigned students (null, undefined, or empty array) = Available to ALL
                if (!assessment.assignedStudents || assessment.assignedStudents.length === 0) {
                    console.log('✅ Assessment has no specific assignments - available to ALL students');
                    return true;
                }
                
                // Case 2: Student is specifically assigned (exact match)
                if (assessment.assignedStudents.includes(currentUser.username)) {
                    console.log('✅ Student is specifically assigned to this assessment');
                    return true;
                }
                
                // Case 3: Case-insensitive matching
                const studentName = currentUser.username.toLowerCase();
                const assignedNames = assessment.assignedStudents.map(name => name.toLowerCase());
                
                if (assignedNames.includes(studentName)) {
                    console.log('✅ Student name matches (case-insensitive)');
                    return true;
                }
                
                console.log('❌ Student not assigned to this assessment');
                return false;
            });

            console.log(`\n=== RESULTS ===`);
            console.log('Student', currentUser.username, 'has access to', myAssessments.length, 'assessments');

            myAssessments.forEach(assessment => {
                const start = new Date(assessment.startDate);
                const end = new Date(assessment.endDate);
                
                const assessmentCard = document.createElement('div');
                assessmentCard.className = 'question-card';
                
                let status = 'Scheduled';
                let statusClass = 'status-pending';
                let actionButton = '';
                
                // Debug timing
                console.log(`Assessment "${assessment.title}" timing check:`);
                console.log('Current time:', now.toLocaleString());
                console.log('Start time:', start.toLocaleString());
                console.log('End time:', end.toLocaleString());
                console.log('now >= start:', now >= start);
                console.log('now <= end:', now <= end);
                
                if (now >= start && now <= end) {
                    status = 'Active';
                    statusClass = 'status-open';
                    
                    const existingSubmission = submissions.find(s => 
                        s.assessmentId === assessment.id && s.studentName === currentUser.username
                    );
                    
                    if (existingSubmission && !existingSubmission.isDraft) {
                        actionButton = '<span class="status-badge status-open">Submitted</span>';
                    } else if (existingSubmission && existingSubmission.isDraft) {
                        actionButton = '<button class="btn btn-warning" onclick="editSubmission(\'' + assessment.id + '\')">Continue Draft</button>';
                    } else {
                        actionButton = '<button class="btn" onclick="takeAssessment(\'' + assessment.id + '\')">Take Assessment</button>';
                    }
                } else if (now > end) {
                    status = 'Closed';
                    statusClass = 'status-closed';
                    actionButton = '<span class="status-badge status-closed">Assessment Ended</span>';
                } else {
                    // Assessment hasn't started yet
                    const timeUntilStart = start - now;
                    const minutesUntilStart = Math.ceil(timeUntilStart / (1000 * 60));
                    
                    if (minutesUntilStart <= 60) {
                        actionButton = `<button class="btn btn-secondary" disabled>Starts in ${minutesUntilStart} minutes</button>`;
                    } else {
                        actionButton = '<button class="btn btn-secondary" disabled>Not Started</button>';
                    }
                }

                assessmentCard.innerHTML = `
                    <div class="question-header">
                        <h4>${assessment.title}</h4>
                        <span class="status-badge ${statusClass}">${status}</span>
                    </div>
                    <p>${assessment.description}</p>
                    <div class="question-meta">
                        <strong>Duration:</strong> ${new Date(assessment.startDate).toLocaleString()} - ${new Date(assessment.endDate).toLocaleString()}<br>
                        <strong>Max Score:</strong> ${assessment.maxScore} points<br>
                        <strong>Questions:</strong> ${assessment.questions ? assessment.questions.length : 0}
                    </div>
                    <div style="margin-top: 15px;">
                        ${actionButton}
                    </div>
                `;
                
                container.appendChild(assessmentCard);
            });

            if (myAssessments.length === 0) {
                console.log('\n=== NO ASSESSMENTS FOUND - DEBUG INFO ===');
                assessments.forEach((assessment, index) => {
                    console.log(`Assessment ${index + 1}: "${assessment.title}"`);
                    console.log('  - Assigned to:', assessment.assignedStudents);
                    console.log('  - Type:', typeof assessment.assignedStudents);
                    console.log('  - Is Array?', Array.isArray(assessment.assignedStudents));
                    console.log('  - Length:', assessment.assignedStudents ? assessment.assignedStudents.length : 'N/A');
                });
                
                container.innerHTML = `
                    <div class="question-card">
                        <h4>No Assessments Available</h4>
                        <p>You currently have no assessments assigned to you.</p>
                        <div class="question-meta">
                            <strong>Your username:</strong> ${currentUser.username}<br>
                            <strong>Total assessments in system:</strong> ${assessments.length}<br>
                            <strong>Debug Info:</strong> Check browser console (F12) for detailed assignment information.
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="refreshStudentAssessments()">🔄 Refresh</button>
                            <button class="btn btn-secondary" onclick="debugStudentInfo()">🐛 Debug Info</button>
                            <button class="btn btn-warning" onclick="clearAndReload()">🔄 Clear & Reload</button>
                            <button class="btn btn-success" onclick="createTestAssessment()">➕ Create Test Assessment</button>
                            <button class="btn" onclick="checkAssessmentTiming()">⏰ Check Timing</button>
                        </div>
                        <p><strong>Quick Username Suggestions:</strong> Try logging in as: john_doe, jane_smith, alice_johnson, bob_wilson, emma_davis</p>
                        <p><em>If you believe this is an error, please contact your administrator.</em></p>
                    </div>
                `;
            }
        }

        function takeAssessment(assessmentId) {
            const assessment = assessments.find(a => a.id === assessmentId);
            if (!assessment || !assessment.questions) {
                alert('Assessment not found or has no questions');
                return;
            }

            const now = new Date();
            const end = new Date(assessment.endDate);
            
            if (now > end) {
                alert('This assessment has ended');
                return;
            }

            currentAssessmentId = assessmentId;
            showAssessmentModal(assessment);
            startTimer(end);
        }

        function editSubmission(assessmentId) {
            const assessment = assessments.find(a => a.id === assessmentId);
            const submission = submissions.find(s => 
                s.assessmentId === assessmentId && s.studentName === currentUser.username
            );
            
            if (!assessment || !submission) {
                alert('Assessment or submission not found');
                return;
            }

            const now = new Date();
            const end = new Date(assessment.endDate);
            
            if (now > end) {
                alert('This assessment has ended. You can no longer edit your submission.');
                return;
            }

            currentAssessmentId = assessmentId;
            showAssessmentModal(assessment, submission);
            startTimer(end);
        }

        function showAssessmentModal(assessment, existingSubmission = null) {
            const modal = document.getElementById('assessmentModal');
            const content = document.getElementById('assessmentContent');
            
            let assessmentHtml = `
                <div class="header">
                    <h2>${assessment.title}</h2>
                    <button class="btn btn-secondary" onclick="closeAssessmentModal()" style="float: right;">Close</button>
                </div>
                <p>${assessment.description}</p>
                <div class="schedule-info">
                    <strong>Time Remaining:</strong> <span id="timeRemaining"></span><br>
                    <strong>Total Points:</strong> ${assessment.maxScore}
                </div>
                <form id="assessmentForm">
            `;

            assessment.questions.forEach((question, index) => {
                const existingAnswers = existingSubmission ? existingSubmission.answers[question.id] || {} : {};
                
                assessmentHtml += `
                    <div class="question-card">
                        <h4>Question ${index + 1} (${question.points} points)</h4>
                        <p>${question.text}</p>
                        ${question.instructions ? `<p><em>Instructions: ${question.instructions}</em></p>` : ''}
                        
                        ${renderMultipleAnswerInputs(question, existingAnswers)}
                    </div>
                `;
            });

            assessmentHtml += `
                </form>
                <div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px dashed #28a745;">
                    <h4 style="color: #28a745; margin-bottom: 15px;">Ready to Submit?</h4>
                    <p style="margin-bottom: 20px; color: #666;">Make sure you've answered all questions before submitting.</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                        <button class="btn btn-secondary" onclick="testFormFunctionality()">🧪 Test Form</button>
                        <button class="btn btn-secondary" onclick="debugAssessmentForm()">🐛 Debug Form</button>
                        <button class="btn btn-secondary" onclick="saveProgress()">💾 Save Progress</button>
                        <button class="btn" id="submitAssessmentBtn" onclick="showSubmissionConfirmation()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); font-size: 18px; padding: 18px 35px; font-weight: bold; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); transform: scale(1.05);">🎯 SUBMIT ASSESSMENT</button>
                        <button class="btn btn-warning" onclick="submitAssessmentWithAnswers()" style="font-size: 14px; padding: 12px 20px;">⚡ DIRECT SUBMIT (No Confirmation)</button>
                    </div>
                    <p style="margin-top: 15px; font-size: 12px; color: #dc3545;"><strong>⚠️ Warning:</strong> You cannot edit your answers after submission!</p>
                </div>
            `;

            content.innerHTML = assessmentHtml;
            modal.style.display = 'block';
        }

        function renderMultipleAnswerInputs(question, existingAnswers) {
            let inputsHtml = '';
            
            question.types.forEach(type => {
                const existingAnswer = existingAnswers[type] || '';
                inputsHtml += `
                    <div class="answer-input-group">
                        <h5>${type.charAt(0).toUpperCase() + type.slice(1)} Answer:</h5>
                        ${renderAnswerInput(question, existingAnswer, type)}
                    </div>
                `;
            });
            
            return inputsHtml;
        }

        function renderAnswerInput(question, existingAnswer, type) {
            const fieldName = `${question.id}_${type}`;
            
            switch(type) {
                case 'text':
                    const minChars = question.textLimit || 0;
                    return `
                        <textarea name="${fieldName}" rows="4" placeholder="Enter your answer here..." 
                                  data-min-chars="${minChars}" 
                                  onkeyup="updateCharCounter('${fieldName}', ${minChars})">${existingAnswer}</textarea>
                        <div class="char-counter" id="counter_${fieldName}">
                            ${existingAnswer.length} / ${minChars} minimum characters
                        </div>
                    `;
                
                case 'code':
                    const minCharsCode = question.textLimit || 0;
                    return `
                        <textarea name="${fieldName}" rows="6" placeholder="Enter your code here..." 
                                  style="font-family: monospace;"
                                  data-min-chars="${minCharsCode}" 
                                  onkeyup="updateCharCounter('${fieldName}', ${minCharsCode})">${existingAnswer}</textarea>
                        <div class="char-counter" id="counter_${fieldName}">
                            ${existingAnswer.length} / ${minCharsCode} minimum characters
                        </div>
                    `;
                
                case 'file':
                    return `
                        <div class="file-upload" onclick="document.getElementById('${fieldName}').click()">
                            <input type="file" id="${fieldName}" name="${fieldName}" style="display: none;" 
                                   accept="image/*,.pdf,.doc,.docx,.txt,.zip,.rar" 
                                   onchange="handleFileUpload('${fieldName}')">
                            <div id="upload-area-${fieldName}">
                                <p>📁 Click to upload file or drag and drop</p>
                                <p style="font-size: 12px; color: #666;">Supported: Images, PDF, Documents, Text files</p>
                                ${existingAnswer ? `<p style="color: #28a745; font-weight: bold;">Current: ${existingAnswer}</p>` : ''}
                            </div>
                        </div>
                    `;
                
                case 'url':
                    return `<input type="url" name="${fieldName}" placeholder="https://github.com/username/repository" value="${existingAnswer}">`;
                
                case 'voice':
                    return `
                        <div>
                            <button type="button" class="btn" onclick="startRecording('${fieldName}')">🎤 Start Recording</button>
                            <button type="button" class="btn btn-secondary" onclick="stopRecording('${fieldName}')" disabled>⏹️ Stop Recording</button>
                            <div id="recording_${fieldName}" style="margin-top: 10px;">
                                ${existingAnswer ? `<p>Recorded: ${existingAnswer}</p>` : ''}
                            </div>
                            <input type="hidden" name="${fieldName}" value="${existingAnswer}">
                        </div>
                    `;
                
                default:
                    return `<input type="text" name="${fieldName}" placeholder="Enter your answer" value="${existingAnswer}">`;
            }
        }

        function updateCharCounter(fieldName, minChars) {
            const textarea = document.querySelector(`[name="${fieldName}"]`);
            const counter = document.getElementById(`counter_${fieldName}`);
            const currentLength = textarea.value.length;
            
            counter.textContent = `${currentLength} / ${minChars} minimum characters`;
            
            if (currentLength >= minChars) {
                counter.className = 'char-counter success';
            } else {
                counter.className = 'char-counter error';
            }
        }

        function startTimer(endDate) {
            function updateTimer() {
                const now = new Date();
                const timeLeft = endDate - now;
                
                if (timeLeft <= 0) {
                    document.getElementById('timeRemaining').textContent = 'Time\'s up!';
                    alert('⏰ Time\'s up! Submitting your assessment automatically...');
                    submitAssessmentWithAnswers();
                    return;
                }
                
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                document.getElementById('timeRemaining').textContent = 
                    `${hours}h ${minutes}m ${seconds}s`;
            }
            
            updateTimer();
            currentTimer = setInterval(updateTimer, 1000);
        }

        function closeAssessmentModal() {
            document.getElementById('assessmentModal').style.display = 'none';
            if (currentTimer) {
                clearInterval(currentTimer);
                currentTimer = null;
            }
        }

        function saveProgress() {
            console.log('=== SAVING ASSESSMENT PROGRESS ===');
            
            const form = document.getElementById('assessmentForm');
            if (!form) {
                console.error('Assessment form not found');
                alert('Error: Assessment form not found');
                return false;
            }
            
            const assessment = assessments.find(a => a.id === currentAssessmentId);
            
            if (!assessment) {
                console.error('Assessment not found:', currentAssessmentId);
                alert('Error: Assessment not found');
                return false;
            }
            
            console.log('Assessment found:', assessment.title);
            
            // NEW IMPROVED ANSWER COLLECTION SYSTEM
            const answers = {};
            
            // Process each question systematically
            assessment.questions.forEach((question, qIndex) => {
                console.log(`\n--- Processing Question ${qIndex + 1}: ${question.id} ---`);
                console.log('Question types:', question.types);
                
                const questionAnswers = {};
                let hasAnyAnswer = false;
                
                question.types.forEach(type => {
                    const fieldName = `${question.id}_${type}`;
                    console.log(`Looking for field: ${fieldName}`);
                    
                    if (type === 'file') {
                        // Handle file inputs
                        const fileInput = form.querySelector(`input[name="${fieldName}"]`);
                        if (fileInput && fileInput.files.length > 0) {
                            const file = fileInput.files[0];
                            const fileInfo = `${file.name} (${(file.size/1024).toFixed(1)}KB)`;
                            questionAnswers[type] = fileInfo;
                            hasAnyAnswer = true;
                            console.log(`✅ Found ${type} answer:`, fileInfo);
                        }
                    } else {
                        // Handle text, url, code, voice inputs
                        const input = form.querySelector(`[name="${fieldName}"]`);
                        if (input && input.value && input.value.trim()) {
                            questionAnswers[type] = input.value.trim();
                            hasAnyAnswer = true;
                            console.log(`✅ Found ${type} answer:`, input.value.substring(0, 50) + '...');
                        }
                    }
                });
                
                // Store answers in the correct nested format
                if (hasAnyAnswer) {
                    answers[question.id] = questionAnswers;
                    console.log(`✅ Stored answers for question ${question.id}:`, questionAnswers);
                } else {
                    console.log(`⚠️ No answers found for question ${question.id}`);
                }
            });
            
            console.log('Final organized answers:', answers);
            
            // Validate text minimums with better error reporting
            let validationErrors = [];
            assessment.questions.forEach((question, index) => {
                const questionNum = index + 1;
                console.log(`Validating question ${questionNum}:`, question.text);
                
                const questionAnswers = answers[question.id] || {};
                
                // Check text requirements
                if (question.types.includes('text') && question.textLimit) {
                    const textAnswer = questionAnswers['text'];
                    const currentLength = textAnswer ? textAnswer.length : 0;
                    
                    console.log(`Question ${questionNum} text validation:`, {
                        required: question.textLimit,
                        current: currentLength,
                        answer: textAnswer ? textAnswer.substring(0, 50) + '...' : 'No answer'
                    });
                    
                    if (!textAnswer || currentLength < question.textLimit) {
                        validationErrors.push(`Question ${questionNum} (Text): Need at least ${question.textLimit} characters (currently ${currentLength})`);
                    }
                }
                
                // Check code requirements
                if (question.types.includes('code') && question.textLimit) {
                    const codeAnswer = questionAnswers['code'];
                    const currentLength = codeAnswer ? codeAnswer.length : 0;
                    
                    console.log(`Question ${questionNum} code validation:`, {
                        required: question.textLimit,
                        current: currentLength,
                        answer: codeAnswer ? codeAnswer.substring(0, 50) + '...' : 'No answer'
                    });
                    
                    if (!codeAnswer || currentLength < question.textLimit) {
                        validationErrors.push(`Question ${questionNum} (Code): Need at least ${question.textLimit} characters (currently ${currentLength})`);
                    }
                }
            });
            
            if (validationErrors.length > 0) {
                console.log('Validation errors found:', validationErrors);
                alert('Please fix these issues before saving:\n\n' + validationErrors.join('\n'));
                return false;
            }
            
            console.log('Validation passed, saving submission...');
            
            // Save to existing submission or create new draft
            let submission = submissions.find(s => 
                s.assessmentId === currentAssessmentId && s.studentName === currentUser.username
            );
            
            if (!submission) {
                submission = {
                    id: 'sub_' + Date.now(),
                    assessmentId: currentAssessmentId,
                    studentName: currentUser.username,
                    answers: {},
                    submittedAt: new Date().toISOString(),
                    isDraft: true
                };
                submissions.push(submission);
                console.log('Created new submission:', submission.id);
            } else {
                console.log('Updating existing submission:', submission.id);
            }
            
            submission.answers = answers;
            submission.lastModified = new Date().toISOString();
            
            console.log('FINAL SUBMISSION STRUCTURE:', JSON.stringify(submission, null, 2));
            
            console.log('Submission saved successfully');
            alert('✅ Progress saved successfully!');
            return true;
        }

        function debugAssessmentForm() {
            console.log('=== ASSESSMENT FORM DEBUG (SIMPLIFIED) ===');
            
            try {
                const form = document.getElementById('assessmentForm');
                if (!form) {
                    alert('❌ Error: Assessment form not found!');
                    return;
                }
                
                const assessment = assessments.find(a => a.id === currentAssessmentId);
                if (!assessment) {
                    alert('❌ Error: Assessment not found!');
                    return;
                }
                
                console.log('Form found, analyzing...');
                
                // Get all form elements
                const allInputs = form.querySelectorAll('input, textarea, select');
                const textInputs = form.querySelectorAll('input[type="text"], textarea');
                const fileInputs = form.querySelectorAll('input[type="file"]');
                const urlInputs = form.querySelectorAll('input[type="url"]');
                
                let debugInfo = `FORM DEBUG REPORT:\n\n`;
                debugInfo += `Assessment: ${assessment.title}\n`;
                debugInfo += `Student: ${currentUser.username}\n\n`;
                
                debugInfo += `FORM ELEMENTS FOUND:\n`;
                debugInfo += `• Total elements: ${allInputs.length}\n`;
                debugInfo += `• Text areas/inputs: ${textInputs.length}\n`;
                debugInfo += `• File inputs: ${fileInputs.length}\n`;
                debugInfo += `• URL inputs: ${urlInputs.length}\n\n`;
                
                debugInfo += `ELEMENT DETAILS:\n`;
                allInputs.forEach((input, index) => {
                    let value = '';
                    if (input.type === 'file') {
                        value = input.files.length > 0 ? `File: ${input.files[0].name}` : 'No file';
                    } else {
                        value = input.value ? `"${input.value.substring(0, 30)}${input.value.length > 30 ? '...' : ''}"` : 'Empty';
                    }
                    
                    debugInfo += `${index + 1}. ${input.type} (${input.name || 'no name'}): ${value}\n`;
                });
                
                debugInfo += `\nVALIDATION CHECK:\n`;
                let canSave = true;
                let canSubmit = true;
                
                assessment.questions.forEach((question, qIndex) => {
                    const qNum = qIndex + 1;
                    debugInfo += `\nQ${qNum}: ${question.text.substring(0, 40)}...\n`;
                    debugInfo += `Required types: ${question.types.join(', ')}\n`;
                    
                    question.types.forEach(type => {
                        const fieldName = `${question.id}_${type}`;
                        const element = form.querySelector(`[name="${fieldName}"]`);
                        
                        if (element) {
                            if (type === 'file') {
                                const hasFile = element.files.length > 0;
                                debugInfo += `  ${type}: ${hasFile ? '✅ File selected' : '⚠️ No file'}\n`;
                            } else {
                                const hasValue = element.value && element.value.trim();
                                let status = hasValue ? '✅ Has value' : '⚠️ Empty';
                                
                                if (hasValue && question.textLimit && (type === 'text' || type === 'code')) {
                                    const length = element.value.length;
                                    if (length < question.textLimit) {
                                        status = `❌ Too short (${length}/${question.textLimit})`;
                                        canSubmit = false;
                                    } else {
                                        status = `✅ Good length (${length}/${question.textLimit})`;
                                    }
                                }
                                
                                debugInfo += `  ${type}: ${status}\n`;
                            }
                        } else {
                            debugInfo += `  ${type}: ❌ Element not found\n`;
                            canSave = false;
                            canSubmit = false;
                        }
                    });
                });
                
                debugInfo += `\nSTATUS:\n`;
                debugInfo += `Can Save Progress: ${canSave ? '✅ YES' : '❌ NO'}\n`;
                debugInfo += `Can Submit: ${canSubmit ? '✅ YES' : '❌ NO'}\n`;
                
                if (!canSubmit) {
                    debugInfo += `\n💡 TIP: You can save as draft and continue editing later.`;
                }
                
                console.log('Form debug completed:', {
                    totalElements: allInputs.length,
                    canSave,
                    canSubmit,
                    assessment: assessment.title
                });
                
                alert(debugInfo);
                
            } catch (error) {
                console.error('Error in form debug:', error);
                alert('❌ Error analyzing form: ' + error.message);
            }
        }

        function testFormFunctionality() {
            console.log('=== TESTING FORM FUNCTIONALITY ===');
            
            try {
                const form = document.getElementById('assessmentForm');
                if (!form) {
                    alert('❌ No assessment form found. Please open an assessment first.');
                    return;
                }
                
                // Test basic form elements
                const allInputs = form.querySelectorAll('input, textarea, select');
                console.log('Found form elements:', allInputs.length);
                
                // Try to collect data like saveProgress does
                const testAnswers = {};
                let elementsProcessed = 0;
                
                allInputs.forEach(input => {
                    if (input.name && input.name.trim()) {
                        elementsProcessed++;
                        
                        if (input.type === 'file') {
                            if (input.files.length > 0) {
                                testAnswers[input.name] = `File: ${input.files[0].name}`;
                            }
                        } else if (input.value && input.value.trim()) {
                            testAnswers[input.name] = input.value.trim();
                        }
                    }
                });
                
                console.log('Test collection results:', {
                    totalElements: allInputs.length,
                    elementsProcessed,
                    answersCollected: Object.keys(testAnswers).length,
                    answers: testAnswers
                });
                
                alert(`✅ Form Test Results:\n\n• Total form elements: ${allInputs.length}\n• Elements with names: ${elementsProcessed}\n• Answers collected: ${Object.keys(testAnswers).length}\n\nForm appears to be working correctly!\n\nCheck console (F12) for detailed results.`);
                
            } catch (error) {
                console.error('Form test error:', error);
                alert('❌ Form test failed: ' + error.message);
            }
        }

        function handleFileUpload(fieldName) {
            console.log('File upload triggered for field:', fieldName);
            
            const fileInput = document.getElementById(fieldName);
            const uploadArea = document.getElementById(`upload-area-${fieldName}`);
            
            if (!fileInput || !uploadArea) {
                console.error('File input or upload area not found');
                return;
            }
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                console.log('File selected:', {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    lastModified: new Date(file.lastModified).toLocaleString()
                });
                
                // Update the upload area to show file info
                const fileSizeKB = (file.size / 1024).toFixed(1);
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                const displaySize = file.size > 1024 * 1024 ? `${fileSizeMB}MB` : `${fileSizeKB}KB`;
                
                uploadArea.innerHTML = `
                    <p style="color: #28a745; font-weight: bold;">✅ File uploaded successfully!</p>
                    <p style="font-size: 14px;"><strong>File:</strong> ${file.name}</p>
                    <p style="font-size: 12px; color: #666;"><strong>Size:</strong> ${displaySize} | <strong>Type:</strong> ${file.type || 'Unknown'}</p>
                    <p style="font-size: 12px; color: #007bff;">Click here to change file</p>
                `;
                
                console.log('File upload UI updated successfully');
            } else {
                console.log('No file selected');
                uploadArea.innerHTML = `
                    <p>📁 Click to upload file or drag and drop</p>
                    <p style="font-size: 12px; color: #666;">Supported: Images, PDF, Documents, Text files</p>
                `;
            }
        }

        function submitAssessmentWithAnswers() {
            console.log('🎯 SUBMIT ASSESSMENT WITH ANSWERS - STARTING 🎯');
            console.log('Current Assessment ID:', currentAssessmentId);
            console.log('Current User:', currentUser);
            
            try {
                if (!currentAssessmentId) {
                    console.error('❌ No assessment ID found');
                    alert('❌ No assessment ID found');
                    return;
                }
                
                // Get the assessment and form
                const assessment = assessments.find(a => a.id === currentAssessmentId);
                const form = document.getElementById('assessmentForm');
                
                console.log('Found assessment:', assessment ? assessment.title : 'NOT FOUND');
                console.log('Found form:', form ? 'YES' : 'NO');
                
                if (!assessment || !form) {
                    console.error('❌ Assessment or form not found');
                    alert('❌ Assessment or form not found');
                    return;
                }
                
                console.log('📋 Assessment:', assessment.title);
                console.log('👤 Student:', currentUser.username);
                
                // Use the same improved answer collection as saveProgress
                const answers = {};
                
                assessment.questions.forEach((question, qIndex) => {
                    console.log(`\n--- Processing Question ${qIndex + 1}: ${question.id} ---`);
                    console.log('Question types:', question.types);
                    
                    const questionAnswers = {};
                    let hasAnyAnswer = false;
                    
                    question.types.forEach(type => {
                        const fieldName = `${question.id}_${type}`;
                        console.log(`Looking for field: ${fieldName}`);
                        
                        if (type === 'file') {
                            const fileInput = form.querySelector(`input[name="${fieldName}"]`);
                            console.log('File input found:', fileInput ? 'YES' : 'NO');
                            if (fileInput && fileInput.files.length > 0) {
                                const file = fileInput.files[0];
                                const fileInfo = `${file.name} (${(file.size/1024).toFixed(1)}KB)`;
                                questionAnswers[type] = fileInfo;
                                hasAnyAnswer = true;
                                console.log(`✅ Found ${type} answer:`, fileInfo);
                            }
                        } else {
                            const input = form.querySelector(`[name="${fieldName}"]`);
                            console.log('Text input found:', input ? 'YES' : 'NO');
                            if (input) {
                                console.log('Input value:', input.value);
                                if (input.value && input.value.trim()) {
                                    questionAnswers[type] = input.value.trim();
                                    hasAnyAnswer = true;
                                    console.log(`✅ Found ${type} answer:`, input.value.substring(0, 50) + '...');
                                }
                            }
                        }
                    });
                    
                    if (hasAnyAnswer) {
                        answers[question.id] = questionAnswers;
                        console.log(`✅ Stored answers for question ${question.id}:`, questionAnswers);
                    } else {
                        console.log(`⚠️ No answers found for question ${question.id}`);
                    }
                });
                
                console.log('\n📋 FINAL COLLECTED ANSWERS:', answers);
                console.log('📊 Total questions answered:', Object.keys(answers).length);
                
                // Find or create submission with collected answers
                let submission = submissions.find(s => 
                    s.assessmentId === currentAssessmentId && s.studentName === currentUser.username
                );
                
                console.log('Existing submission found:', submission ? 'YES' : 'NO');
                
                if (!submission) {
                    submission = {
                        id: 'sub_' + Date.now(),
                        assessmentId: currentAssessmentId,
                        studentName: currentUser.username,
                        answers: answers,
                        submittedAt: new Date().toISOString(),
                        isDraft: false
                    };
                    submissions.push(submission);
                    console.log('✅ Created new submission:', submission.id);
                } else {
                    submission.answers = answers;
                    submission.isDraft = false;
                    submission.submittedAt = new Date().toISOString();
                    console.log('✅ Updated existing submission:', submission.id);
                }
                
                console.log('💾 Final submission structure:', JSON.stringify(submission, null, 2));
                console.log('📊 Total submissions in system:', submissions.length);
                
                // Close modal
                console.log('🚪 Closing assessment modal...');
                closeAssessmentModal();
                
                // Success message
                const successMessage = `🎉 ASSESSMENT SUBMITTED SUCCESSFULLY! 🎉\n\nYour submission details:\n• Questions answered: ${Object.keys(answers).length}\n• Submission ID: ${submission.id}\n• Submitted at: ${new Date().toLocaleString()}\n\nYou can view your answers in "My Submissions" tab.`;
                console.log('✅ Success message:', successMessage);
                alert(successMessage);
                
                // Refresh student dashboard
                console.log('🔄 Refreshing student dashboard...');
                loadStudentAssessments();
                console.log('✅ SUBMISSION COMPLETED SUCCESSFULLY!');
                
            } catch (error) {
                console.error('❌ SUBMISSION ERROR:', error);
                console.error('Error stack:', error.stack);
                alert(`❌ Error during submission: ${error.message}\n\nPlease try again or contact support.`);
            }
        }

        function showSubmissionConfirmation() {
            console.log('📋 Showing custom submission confirmation dialog');
            
            // Create custom confirmation modal
            const confirmationHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                        <h3 style="color: #28a745; margin-bottom: 20px;">🎯 Submit Assessment</h3>
                        <p style="margin-bottom: 20px; font-size: 16px;">
                            Are you sure you want to submit this assessment?
                        </p>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                            <p style="margin: 0; font-weight: bold; color: #856404;">⚠️ Important:</p>
                            <ul style="margin: 10px 0; padding-left: 20px; color: #856404;">
                                <li>You cannot edit your answers after submission</li>
                                <li>Make sure all your answers are complete</li>
                                <li>This action cannot be undone</li>
                            </ul>
                        </div>
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button class="btn btn-secondary" onclick="cancelSubmissionConfirmation()" style="min-width: 120px;">Cancel</button>
                            <button class="btn" onclick="confirmSubmissionFinal()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); min-width: 120px;">Submit Now</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            const modal = document.createElement('div');
            modal.id = 'submissionConfirmationModal';
            modal.innerHTML = confirmationHTML;
            document.body.appendChild(modal);
            console.log('✅ Custom confirmation dialog added to page');
        }

        function cancelSubmissionConfirmation() {
            console.log('User cancelled submission via custom modal');
            const modal = document.getElementById('submissionConfirmationModal');
            if (modal) {
                modal.remove();
            }
        }

        function confirmSubmissionFinal() {
            console.log('User confirmed submission via custom modal');
            
            // Remove the confirmation modal
            const modal = document.getElementById('submissionConfirmationModal');
            if (modal) {
                modal.remove();
            }
            
            // Proceed with actual submission
            submitAssessmentWithAnswers();
        }

        function startRecording(fieldName) {
            const recordButton = event.target;
            const stopButton = recordButton.nextElementSibling;
            const recordingDiv = document.getElementById('recording_' + fieldName);
            const hiddenInput = document.querySelector(`input[name="${fieldName}"]`);
            
            recordButton.disabled = true;
            stopButton.disabled = false;
            
            recordingDiv.innerHTML = '<p style="color: red;">🔴 Recording...</p>';
            
            setTimeout(() => {
                const filename = `voice_recording_${Date.now()}.wav`;
                recordingDiv.innerHTML = `<p style="color: green;">✅ Recording saved: ${filename}</p>`;
                hiddenInput.value = filename;
                
                recordButton.disabled = false;
                stopButton.disabled = true;
            }, 2000);
        }

        function stopRecording(fieldName) {
            // This would normally stop the actual recording
        }

        function loadMySubmissions() {
            const container = document.getElementById('mySubmissionsList');
            container.innerHTML = '';

            const mySubmissions = submissions.filter(s => s.studentName === currentUser.username);

            mySubmissions.forEach(submission => {
                const assessment = assessments.find(a => a.id === submission.assessmentId);
                if (!assessment) return;

                const submissionCard = document.createElement('div');
                submissionCard.className = 'question-card';
                
                const status = submission.isDraft ? 'Draft' : 'Submitted';
                const statusClass = submission.isDraft ? 'status-pending' : 'status-open';
                
                submissionCard.innerHTML = `
                    <div class="question-header">
                        <h4>${assessment.title}</h4>
                        <span class="status-badge ${statusClass}">${status}</span>
                    </div>
                    <div class="question-meta">
                        <strong>Last Modified:</strong> ${new Date(submission.lastModified || submission.submittedAt).toLocaleString()}<br>
                        <strong>Status:</strong> ${submission.graded ? 'Graded' : 'Pending Review'}
                        ${submission.score !== undefined ? `<br><strong>Score:</strong> ${submission.score} / ${assessment.maxScore}` : ''}
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="viewMyAnswers('${submission.id}')">👁️ View My Answers</button>
                        ${submission.isDraft ? `<button class="btn btn-warning" onclick="editSubmission('${assessment.id}')">📝 Continue Editing</button>` : ''}
                        <button class="btn btn-secondary" onclick="debugMySubmission('${submission.id}')">🐛 Debug Submission</button>
                    </div>
                `;
                
                container.appendChild(submissionCard);
            });

            if (mySubmissions.length === 0) {
                container.innerHTML = '<p>No submissions yet.</p>';
            }
        }

        function viewMyAnswers(submissionId) {
            console.log('=== VIEWING STUDENT ANSWERS ===');
            
            const submission = submissions.find(s => s.id === submissionId);
            const assessment = assessments.find(a => a.id === submission.assessmentId);
            
            if (!submission || !assessment) {
                alert('❌ Submission or assessment not found');
                return;
            }

            console.log('Viewing answers for submission:', submission);
            console.log('Assessment:', assessment);
            console.log('Submission answers:', submission.answers);
            
            let answersHtml = `
                <h3>My Answers: ${assessment.title}</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p><strong>Submitted:</strong> ${new Date(submission.submittedAt).toLocaleString()}</p>
                    <p><strong>Status:</strong> ${submission.isDraft ? 'Draft' : 'Final Submission'}</p>
                    ${submission.graded ? `<p><strong>Score:</strong> ${submission.score} / ${assessment.maxScore}</p>` : '<p><strong>Status:</strong> Pending Review</p>'}
                    <p><strong>Submission ID:</strong> ${submission.id}</p>
                </div>
                <div style="max-height: 500px; overflow-y: auto;">
            `;

            assessment.questions.forEach((question, index) => {
                const questionNum = index + 1;
                console.log(`\n--- Displaying question ${questionNum}: ${question.id} ---`);
                
                // Get answers for this question using the same logic as grading
                const questionAnswers = submission.answers ? submission.answers[question.id] : null;
                console.log(`Answers for question ${question.id}:`, questionAnswers);
                
                answersHtml += `
                    <div class="question-card">
                        <h4>Question ${questionNum} (${question.points} points)</h4>
                        <p><strong>Question:</strong> ${question.text}</p>
                        ${question.instructions ? `<p><em>Instructions: ${question.instructions}</em></p>` : ''}
                        <div class="answer-display">
                            <strong>My Answers:</strong><br>
                `;
                
                // Display answers
                if (questionAnswers && typeof questionAnswers === 'object' && Object.keys(questionAnswers).length > 0) {
                    // Multiple answer types (object format)
                    Object.entries(questionAnswers).forEach(([type, answer]) => {
                        if (answer && answer.toString().trim()) {
                            answersHtml += formatAnswerForStudent(answer, type, type);
                        }
                    });
                } else if (questionAnswers && typeof questionAnswers === 'string' && questionAnswers.trim()) {
                    // Single answer (string format)
                    answersHtml += formatAnswerForStudent(questionAnswers, 'text', 'Answer');
                } else {
                    // No answers found
                    answersHtml += `
                        <div style="color: #dc3545; font-style: italic; background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
                            <p>⚠️ No answer submitted for this question</p>
                        </div>
                    `;
                    console.log(`❌ No answer found for question ${question.id}`);
                }
                
                // Show score if graded
                if (submission.graded && submission.scores && submission.scores[question.id] !== undefined) {
                    const score = submission.scores[question.id];
                    const percentage = ((score / question.points) * 100).toFixed(1);
                    answersHtml += `
                        <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                            <strong>Score:</strong> ${score} / ${question.points} points (${percentage}%)
                        </div>
                    `;
                }
                
                answersHtml += `
                        </div>
                    </div>
                `;
            });

            answersHtml += `
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Close</button>
                </div>
            `;

            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1001;';
            modal.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 95%; max-width: 900px; max-height: 90%; overflow-y: auto;">
                    ${answersHtml}
                </div>
            `;
            document.body.appendChild(modal);
        }

        function formatAnswerForStudent(answer, type, label) {
            if (!answer) return `<p><strong>${label}:</strong> <em>No answer provided</em></p>`;
            
            let formattedAnswer = '';
            
            switch(type.toLowerCase()) {
                case 'text':
                case 'code':
                    formattedAnswer = `
                        <div style="margin-bottom: 15px;">
                            <p><strong>${label.toUpperCase()}:</strong></p>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea; white-space: pre-wrap; font-family: ${type === 'code' ? 'monospace' : 'inherit'};">
                                ${answer}
                            </div>
                            <small style="color: #666;">Length: ${answer.length} characters</small>
                        </div>
                    `;
                    break;
                case 'file':
                    formattedAnswer = `
                        <div style="margin-bottom: 15px;">
                            <p><strong>FILE UPLOAD:</strong></p>
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                                📎 ${answer}
                            </div>
                        </div>
                    `;
                    break;
                case 'url':
                    formattedAnswer = `
                        <div style="margin-bottom: 15px;">
                            <p><strong>URL LINK:</strong></p>
                            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                                🔗 <a href="${answer}" target="_blank" style="color: #1976d2; text-decoration: none;">${answer}</a>
                            </div>
                        </div>
                    `;
                    break;
                case 'voice':
                    formattedAnswer = `
                        <div style="margin-bottom: 15px;">
                            <p><strong>VOICE RECORDING:</strong></p>
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                                🎤 ${answer}
                            </div>
                        </div>
                    `;
                    break;
                default:
                    formattedAnswer = `
                        <div style="margin-bottom: 15px;">
                            <p><strong>${label.toUpperCase()}:</strong></p>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                ${answer}
                            </div>
                        </div>
                    `;
            }
            
            return formattedAnswer;
        }

        function debugMySubmission(submissionId) {
            console.log('=== STUDENT DEBUGGING SUBMISSION ===');
            
            const submission = submissions.find(s => s.id === submissionId);
            if (!submission) {
                alert('❌ Submission not found!');
                return;
            }
            
            let debugInfo = `MY SUBMISSION DEBUG:\n\n`;
            debugInfo += `Submission ID: ${submission.id}\n`;
            debugInfo += `Assessment ID: ${submission.assessmentId}\n`;
            debugInfo += `Submitted: ${new Date(submission.submittedAt).toLocaleString()}\n`;
            debugInfo += `Is Draft: ${submission.isDraft ? 'Yes' : 'No'}\n`;
            debugInfo += `Is Graded: ${submission.graded ? 'Yes' : 'No'}\n\n`;
            
            debugInfo += `ANSWERS STRUCTURE:\n`;
            if (submission.answers && Object.keys(submission.answers).length > 0) {
                debugInfo += `Total Questions Answered: ${Object.keys(submission.answers).length}\n\n`;
                
                Object.entries(submission.answers).forEach(([questionId, answers]) => {
                    debugInfo += `Question: ${questionId}\n`;
                    if (typeof answers === 'object') {
                        Object.entries(answers).forEach(([type, answer]) => {
                            const preview = answer.length > 50 ? answer.substring(0, 50) + '...' : answer;
                            debugInfo += `  ${type}: ${preview}\n`;
                        });
                    } else {
                        const preview = answers.length > 50 ? answers.substring(0, 50) + '...' : answers;
                        debugInfo += `  Answer: ${preview}\n`;
                    }
                    debugInfo += `\n`;
                });
            } else {
                debugInfo += `❌ No answers found in submission!\n`;
            }
            
            if (submission.graded && submission.scores) {
                debugInfo += `SCORES:\n`;
                Object.entries(submission.scores).forEach(([questionId, score]) => {
                    debugInfo += `${questionId}: ${score} points\n`;
                });
                debugInfo += `Total Score: ${submission.score}\n`;
            }
            
            console.log('Full submission object:', submission);
            alert(debugInfo);
        }

        function loadMyResults() {
            const container = document.getElementById('myResultsList');
            container.innerHTML = '';

            const myAllSubmissions = submissions.filter(s => s.studentName === currentUser.username);
            const myGradedSubmissions = myAllSubmissions.filter(s => s.graded);

            // Show all submissions (graded and ungraded)
            myAllSubmissions.forEach(submission => {
                const assessment = assessments.find(a => a.id === submission.assessmentId);
                if (!assessment) return;

                const resultCard = document.createElement('div');
                resultCard.className = 'question-card';
                
                let percentage = 'Pending';
                let gradeClass = 'status-pending';
                let statusText = 'Awaiting Grade';
                
                if (submission.graded) {
                    percentage = ((submission.score / assessment.maxScore) * 100).toFixed(1) + '%';
                    if (parseFloat(percentage) >= 80) gradeClass = 'status-open';
                    else if (parseFloat(percentage) < 60) gradeClass = 'status-closed';
                    statusText = 'Graded';
                }
                
                resultCard.innerHTML = `
                    <div class="question-header">
                        <h4>${assessment.title}</h4>
                        <span class="status-badge ${gradeClass}">${percentage}</span>
                    </div>
                    <div class="question-meta">
                        <strong>Status:</strong> ${statusText}<br>
                        ${submission.graded ? 
                            `<strong>Score:</strong> ${submission.score} / ${assessment.maxScore}<br>
                             <strong>Graded:</strong> ${new Date(submission.gradedAt).toLocaleString()}<br>` : 
                            ''
                        }
                        <strong>Submitted:</strong> ${new Date(submission.submittedAt).toLocaleString()}<br>
                        <strong>Draft:</strong> ${submission.isDraft ? 'Yes' : 'No'}
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="viewMyAnswers('${submission.id}')">👁️ View My Answers</button>
                        ${submission.graded ? 
                            `<button class="btn" onclick="viewDetailedResults('${submission.id}')">📊 Detailed Results</button>` : 
                            `<button class="btn btn-warning" onclick="alert('This submission is still being graded.')">⏳ Pending Grade</button>`
                        }
                    </div>
                `;
                
                container.appendChild(resultCard);
            });

            if (myAllSubmissions.length === 0) {
                container.innerHTML = `
                    <div class="question-card">
                        <h4>No Results Yet</h4>
                        <p>You haven't submitted any assessments yet.</p>
                        <button class="btn" onclick="showStudentTab('available-assessments')">View Available Assessments</button>
                    </div>
                `;
            } else if (myGradedSubmissions.length === 0) {
                container.innerHTML = `
                    <div class="question-card">
                        <h4>Submissions Under Review</h4>
                        <p>You have ${myAllSubmissions.length} submission(s) that are being graded.</p>
                        <p>Check back later for your results!</p>
                    </div>
                ` + container.innerHTML;
            }
        }

        function viewDetailedResults(submissionId) {
            console.log('=== VIEWING DETAILED RESULTS ===');
            
            const submission = submissions.find(s => s.id === submissionId);
            const assessment = assessments.find(a => a.id === submission.assessmentId);
            
            if (!submission || !assessment) {
                alert('❌ Submission or assessment not found');
                return;
            }

            if (!submission.graded) {
                alert('⏳ This submission hasn\'t been graded yet.');
                return;
            }

            console.log('Viewing detailed results for submission:', submission);
            
            const totalPossible = assessment.maxScore;
            const totalEarned = submission.score;
            const percentage = ((totalEarned / totalPossible) * 100).toFixed(1);
            
            let resultsHtml = `
                <h3>Detailed Results: ${assessment.title}</h3>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                    <h2 style="margin: 0; font-size: 2.5em;">${percentage}%</h2>
                    <p style="margin: 5px 0; font-size: 1.2em;">${totalEarned} / ${totalPossible} points</p>
                    <p style="margin: 0;">Graded on ${new Date(submission.gradedAt).toLocaleString()}</p>
                </div>
                <div style="max-height: 500px; overflow-y: auto;">
            `;

            let questionsCorrect = 0;
            assessment.questions.forEach((question, index) => {
                const questionNum = index + 1;
                const questionScore = submission.scores ? submission.scores[question.id] || 0 : 0;
                const questionAnswers = submission.answers ? submission.answers[question.id] : null;
                const questionPercentage = ((questionScore / question.points) * 100).toFixed(1);
                
                if (questionScore === question.points) questionsCorrect++;
                
                let scoreClass = 'status-pending';
                if (questionScore === question.points) scoreClass = 'status-open';
                else if (questionScore === 0) scoreClass = 'status-closed';
                
                resultsHtml += `
                    <div class="question-card">
                        <div class="question-header">
                            <h4>Question ${questionNum}</h4>
                            <span class="status-badge ${scoreClass}">${questionScore}/${question.points} (${questionPercentage}%)</span>
                        </div>
                        <p><strong>Question:</strong> ${question.text}</p>
                        ${question.instructions ? `<p><em>Instructions: ${question.instructions}</em></p>` : ''}
                        
                        <div class="answer-display">
                            <strong>My Answer:</strong><br>
                `;
                
                // Display the student's answers
                if (questionAnswers && typeof questionAnswers === 'object' && Object.keys(questionAnswers).length > 0) {
                    Object.entries(questionAnswers).forEach(([type, answer]) => {
                        if (answer && answer.toString().trim()) {
                            resultsHtml += formatAnswerForStudent(answer, type, type);
                        }
                    });
                } else if (questionAnswers && typeof questionAnswers === 'string' && questionAnswers.trim()) {
                    resultsHtml += formatAnswerForStudent(questionAnswers, 'text', 'Answer');
                } else {
                    resultsHtml += `<p style="color: #dc3545; font-style: italic;">No answer submitted</p>`;
                }
                
                resultsHtml += `
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: ${scoreClass === 'status-open' ? '#d4edda' : scoreClass === 'status-closed' ? '#f8d7da' : '#fff3cd'}; border-radius: 5px;">
                            <strong>Score: ${questionScore} / ${question.points} points</strong>
                            ${questionScore === question.points ? ' ✅ Perfect!' : questionScore > 0 ? ' ✓ Partial Credit' : ' ❌ No Points'}
                        </div>
                    </div>
                `;
            });

            // Summary stats
            const questionsTotal = assessment.questions.length;
            resultsHtml += `
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h4>Performance Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #667eea;">${percentage}%</div>
                            <div>Overall Score</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #28a745;">${questionsCorrect}</div>
                            <div>Perfect Scores</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #007bff;">${questionsTotal}</div>
                            <div>Total Questions</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #6f42c1;">${totalEarned}</div>
                            <div>Points Earned</div>
                        </div>
                    </div>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Close</button>
                </div>
            `;

            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1001;';
            modal.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 95%; max-width: 1000px; max-height: 90%; overflow-y: auto;">
                    ${resultsHtml}
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== APPLICATION STARTING ===');
            
            // Force clear any existing data and initialize fresh sample data
            assessments = [];
            submissions = [];
            initializeSampleData();
            
            console.log('Application initialized with fresh data');
            console.log('Total assessments:', assessments.length);
            
            // Define the global submit function here to ensure it's loaded
            window.submitAssessmentDirectly = function() {
                console.log('🎯 WINDOW SUBMIT - GUARANTEED ACCESS 🎯');
                
                try {
                    if (!currentAssessmentId) {
                        alert('❌ No assessment ID found');
                        return;
                    }
                    
                    console.log('📋 Assessment ID:', currentAssessmentId);
                    console.log('👤 Student:', currentUser ? currentUser.username : 'Unknown');
                    
                    // Create or find submission
                    let submission = submissions.find(s => 
                        s.assessmentId === currentAssessmentId && 
                        s.studentName === (currentUser ? currentUser.username : 'student')
                    );
                    
                    if (!submission) {
                        submission = {
                            id: 'sub_' + Date.now(),
                            assessmentId: currentAssessmentId,
                            studentName: currentUser ? currentUser.username : 'student',
                            answers: {'submitted': 'Assessment completed at ' + new Date().toLocaleString()},
                            submittedAt: new Date().toISOString(),
                            isDraft: false
                        };
                        submissions.push(submission);
                        console.log('✨ Created submission:', submission.id);
                    } else {
                        submission.isDraft = false;
                        submission.submittedAt = new Date().toISOString();
                        console.log('📝 Updated submission:', submission.id);
                    }
                    
                    console.log('💾 Submission completed');
                    
                    // Close modal manually
                    const modal = document.getElementById('assessmentModal');
                    if (modal) {
                        modal.style.display = 'none';
                        console.log('🚪 Modal closed');
                    }
                    
                    // Clear timer
                    if (currentTimer) {
                        clearInterval(currentTimer);
                        currentTimer = null;
                    }
                    
                    // Success message
                    alert('🎉 ASSESSMENT SUBMITTED! 🎉\n\nYour submission has been saved successfully.\n\nYou can view it in "My Submissions" tab.');
                    
                    // Refresh dashboard
                    if (typeof loadStudentAssessments === 'function') {
                        loadStudentAssessments();
                        console.log('🔄 Dashboard refreshed');
                    }
                    
                    console.log('✅ WINDOW SUBMIT COMPLETED!');
                    
                } catch (error) {
                    console.error('❌ ERROR:', error);
                    alert('❌ Error: ' + error.message);
                }
            };
            
            console.log('✅ Global submit function defined');
            
            // Set smart default dates for assessment creation
            setSmartDefaults();
            
            // Add event listeners for datetime inputs
            addDateTimeListeners();

            // Enhanced file upload drag and drop functionality
            document.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (e.target.classList.contains('file-upload') || e.target.closest('.file-upload')) {
                    const fileUpload = e.target.classList.contains('file-upload') ? e.target : e.target.closest('.file-upload');
                    fileUpload.classList.add('dragover');
                }
            });

            document.addEventListener('dragleave', function(e) {
                if (e.target.classList.contains('file-upload') || e.target.closest('.file-upload')) {
                    const fileUpload = e.target.classList.contains('file-upload') ? e.target : e.target.closest('.file-upload');
                    fileUpload.classList.remove('dragover');
                }
            });

            document.addEventListener('drop', function(e) {
                e.preventDefault();
                
                if (e.target.classList.contains('file-upload') || e.target.closest('.file-upload')) {
                    const fileUpload = e.target.classList.contains('file-upload') ? e.target : e.target.closest('.file-upload');
                    fileUpload.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const fileInput = fileUpload.querySelector('input[type="file"]');
                        if (fileInput) {
                            // Create a new FileList with the dropped files
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(files[0]); // Only take the first file
                            fileInput.files = dataTransfer.files;
                            
                            // Trigger the change event to update UI
                            const fieldName = fileInput.id;
                            handleFileUpload(fieldName);
                            
                            console.log('File dropped and processed:', files[0].name);
                        }
                    }
                }
            });
        });

        // Simplified Date/Time Functions
        function setSmartDefaults() {
            const now = new Date();
            const tomorrow9AM = new Date(now);
            tomorrow9AM.setDate(tomorrow9AM.getDate() + 1);
            tomorrow9AM.setHours(9, 0, 0, 0);
            
            const oneWeekLater = new Date(tomorrow9AM);
            oneWeekLater.setDate(oneWeekLater.getDate() + 7);
            oneWeekLater.setHours(17, 0, 0, 0);
            
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            if (startDateInput && endDateInput) {
                startDateInput.value = tomorrow9AM.toISOString().slice(0, 16);
                endDateInput.value = oneWeekLater.toISOString().slice(0, 16);
                updateSimpleDuration();
            }
        }

        function setQuickPreset(presetType) {
            console.log('Setting quick preset:', presetType);
            
            // Remove active class from all preset buttons
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            const now = new Date();
            let startDate, endDate;
            
            switch(presetType) {
                case 'now-1hour':
                    startDate = new Date(now);
                    endDate = new Date(now.getTime() + 60 * 60 * 1000);
                    break;
                    
                case 'now-1day':
                    startDate = new Date(now);
                    endDate = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                    break;
                    
                case 'tomorrow-1week':
                    startDate = new Date(now);
                    startDate.setDate(startDate.getDate() + 1);
                    startDate.setHours(9, 0, 0, 0);
                    endDate = new Date(startDate.getTime() + 7 * 24 * 60 * 60 * 1000);
                    endDate.setHours(17, 0, 0, 0);
                    break;
                    
                default:
                    console.error('Unknown preset type:', presetType);
                    return;
            }
            
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            if (startDateInput && endDateInput) {
                startDateInput.value = startDate.toISOString().slice(0, 16);
                endDateInput.value = endDate.toISOString().slice(0, 16);
                updateSimpleDuration();
                console.log('Preset applied successfully');
            } else {
                console.error('Date inputs not found');
            }
        }

        function updateSimpleDuration() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const durationInfo = document.getElementById('durationInfo');
            const durationText = document.getElementById('durationText');
            
            if (!startDateInput || !endDateInput || !durationInfo || !durationText) return;
            
            if (startDateInput.value && endDateInput.value) {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                
                if (endDate <= startDate) {
                    durationInfo.style.display = 'block';
                    durationText.textContent = '⚠️ End date must be after start date';
                    durationText.style.color = '#dc3545';
                    return;
                }
                
                const duration = endDate - startDate;
                const days = Math.floor(duration / (1000 * 60 * 60 * 24));
                const hours = Math.floor((duration % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                let durationString = 'Duration: ';
                if (days > 0) durationString += `${days} day${days > 1 ? 's' : ''} `;
                if (hours > 0) durationString += `${hours} hour${hours > 1 ? 's' : ''}`;
                
                durationInfo.style.display = 'block';
                durationText.textContent = durationString;
                durationText.style.color = '#1976d2';
            } else {
                durationInfo.style.display = 'none';
            }
        }

        function addDateTimeListeners() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            if (startDateInput && endDateInput) {
                startDateInput.addEventListener('change', updateSimpleDuration);
                endDateInput.addEventListener('change', updateSimpleDuration);
            }
        }
    </script>
</body>
</html>